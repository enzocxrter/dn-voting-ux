<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Dn Brotato Taterz Farm</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Dn Brotato Taterz Farm" />

    <!-- Simple data URI favicon to avoid 404s -->
    <link rel="icon" href="data:," />

    <!-- Ethers.js v5 (UMD build) -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

    <style>
      @font-face {
        font-family: "OverstreetBibleBold";
        src: url("assets/fonts/overstreetbiblebold.ttf") format("truetype");
        font-weight: normal;
        font-style: normal;
        font-display: swap;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "OverstreetBibleBold", system-ui, -apple-system,
          BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: #ffffff;
        background: url("assets/images/background2.png") center center / cover
          no-repeat fixed;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .page {
        width: 100%;
        max-width: 1200px;
        padding: 20px 16px 60px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      /* HEADER / LOGO BAR */
      .header {
        width: 100%;
        height: 100px;
        background: transparent;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0;
      }

      .header-link {
        display: inline-block;
      }

      .header-logo {
        height: 80px;
        width: auto;
        transition: transform 0.3s ease;
      }

      .header-logo:hover {
        transform: scale(1.05);
      }

      /* TITLE */
      h1 {
        margin: 60px 0 40px;
        text-align: center;
        font-size: clamp(2.5rem, 5vw, 4.5rem);
        line-height: 1.1;
        text-transform: uppercase;
        text-shadow: 0 3px 6px rgba(0, 0, 0, 0.4);
        color: #000000; /* black title */
      }

      /* CONNECT SECTION */
      .connect-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
      }

      .connect-btn {
        border: none;
        padding: 0;
        background: transparent;
        cursor: pointer;
        display: block;
        width: 260px;
        height: 80px;
        background-image: url("assets/images/connect.png");
        background-position: center;
        background-repeat: no-repeat;
        background-size: contain;
        transition:
          transform 0.15s ease-out,
          background-image 0.15s ease-out;
      }

      /* Grow by 15% on hover + hover image */
      .connect-btn:hover {
        background-image: url("assets/images/connecthover.png");
        transform: scale(1.15);
      }

      .connect-btn:active {
        transform: scale(0.98);
      }

      /* Hover text under connect */
      .connect-hover-text {
        margin-top: 16px;
        width: 100%;
        max-width: 600px;
        text-align: center;
        color: #f5f5f5;
        font-size: 2rem;
        opacity: 0;
        transform: translateY(8px);
        transition:
          opacity 0.2s ease-out,
          transform 0.2s ease-out;
        pointer-events: none;
      }

      .connect-wrapper:hover .connect-hover-text {
        opacity: 1;
        transform: translateY(0);
      }

      /* VOTING STATION */
      .voting-station {
        margin-top: 20px;
        width: 100%;
        max-width: 540px; /* narrower center box */
        text-align: center;
        color: #ffffff;
      }

      /* Layout: thermometer on left, stats on right */
      .voting-layout {
        display: flex;
        gap: 24px;
        align-items: flex-start;
        justify-content: center;
      }

      .voting-content {
        flex: 1;
        min-width: 0;
      }

      .voting-title {
        font-size: clamp(2rem, 4vw, 3rem);
        text-transform: uppercase;
        margin-bottom: 16px;
        text-shadow: 0 3px 6px rgba(0, 0, 0, 0.5);
      }

      /* PoH status line */
      .poh-status {
        margin-bottom: 6px;
        font-size: 1.4rem;
      }

      .poh-status-label {
        color: #ffffff;
      }

      .poh-status-yes {
        color: #00ffe8;
        text-shadow:
          0 0 3px #000,
          0 0 6px #000;
        font-weight: 700;
      }

      /* Rank line */
      .rank-line {
        margin-bottom: 20px;
      }

      .rank-label {
        display: inline-block;
        padding: 4px 14px;
        border-radius: 999px;
        background: rgba(0, 0, 0, 0.6);
        color: #00ffe8;
        text-shadow:
          0 0 3px #000,
          0 0 6px #000;
        font-size: 1.4rem;
        font-weight: 700;
      }

      .vote-stats {
        display: flex;
        flex-direction: column;
        gap: 12px;
        font-size: 1.4rem;
        margin-bottom: 20px;
      }

      .vote-stat-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(0, 0, 0, 0.45);
        padding: 10px 16px;
        border-radius: 10px;
      }

      .vote-stat-label {
        text-align: left;
      }

      .vote-stat-value {
        text-align: right;
      }

      /* Vote action area */
      .vote-action {
        margin-top: 10px;
        font-size: 1.6rem;
      }

      /* Image-based VOTE button */
      .vote-btn {
        border: none;
        padding: 0;
        background: transparent;
        cursor: pointer;
        display: inline-block;
        width: 220px;
        height: 70px;
        background-image: url("assets/images/vote.png");
        background-position: center;
        background-repeat: no-repeat;
        background-size: contain;
        transition:
          transform 0.15s ease-out,
          background-image 0.15s ease-out;
      }

      .vote-btn:hover {
        background-image: url("assets/images/votehover.png");
        transform: scale(1.15);
      }

      .vote-btn:active {
        transform: scale(0.98);
      }

      .no-votes-text {
        font-size: 1.6rem;
        opacity: 0.9;
      }

      /* CLAIM STATION (inside same box, under vote UX) */
      .claim-section {
        margin-top: 26px;
        padding-top: 16px;
        border-top: 1px dashed rgba(255, 255, 255, 0.25);
      }

      .claim-title {
        font-size: 1.4rem;
        text-transform: uppercase;
        margin-bottom: 12px;
        text-shadow: 0 3px 6px rgba(0, 0, 0, 0.5);
      }

      .claim-stats {
        display: flex;
        flex-direction: column;
        gap: 10px;
        font-size: 1.3rem;
        margin-bottom: 18px;
      }

      .claim-stat-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(0, 0, 0, 0.4);
        padding: 8px 14px;
        border-radius: 10px;
      }

      .claim-action {
        margin-top: 6px;
        font-size: 1.4rem;
      }

      .claim-btn {
        border: none;
        padding: 0;
        background: transparent;
        cursor: pointer;
        display: inline-block;
        width: 220px;
        height: 70px;
        background-image: url("assets/images/claim.png");
        background-position: center;
        background-repeat: no-repeat;
        background-size: contain;
        transition:
          transform 0.15s ease-out,
          background-image 0.15s ease-out;
      }

      .claim-btn:hover {
        background-image: url("assets/images/claimhover.png");
        transform: scale(1.15);
      }

      .claim-btn:active {
        transform: scale(0.98);
      }

      .no-claims-text {
        font-size: 1.4rem;
        opacity: 0.9;
      }

      /* Not PoH verified panel */
      .not-verified {
        margin-top: 24px;
        text-align: center;
        font-size: 1.4rem;
      }

      .verify-button {
        margin-top: 12px;
        display: inline-block;
        padding: 10px 24px;
        border-radius: 999px;
        background: #000000;
        color: #ffffff;
        text-decoration: none;
        text-transform: uppercase;
        font-size: 1.2rem;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.6);
      }

      /* LEFT SIDE: VOTE THERMOMETER */
      .thermo-wrapper {
        width: 200px;
        padding: 16px 12px 20px;
        background: rgba(0, 0, 0, 0.6);
        border-radius: 20px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.7);
        text-align: center;
      }

      .thermo-title {
        font-size: 1.4rem;
        text-transform: uppercase;
        margin-bottom: 12px;
      }

      .thermo-body {
        position: relative;
        width: 90px;
        height: 460px; /* tall thermometer */
        margin: 0 auto 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .thermo-column {
        position: relative;
        width: 36px;
        height: 340px;
        margin-top: 6px;
        border-radius: 999px;
        border: 4px solid rgba(255, 255, 255, 0.9);
        overflow: hidden;
        background: linear-gradient(
          to top,
          rgba(255, 255, 255, 0.12),
          rgba(255, 255, 255, 0.25)
        );
      }

      .thermo-mercury {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 0%; /* JS updates this */
        background: linear-gradient(
          to top,
          #12ceec,
          #00ffe8
        );
        box-shadow: 0 0 12px rgba(0, 255, 232, 0.8);
        transition: height 0.6s ease-out;
      }

      .thermo-bulb {
        width: 56px;
        height: 56px;
        border-radius: 999px;
        border: 4px solid rgba(255, 255, 255, 0.95);
        background: radial-gradient(
          circle at 30% 30%,
          #00ffe8,
          #12ceec
        );
        box-shadow: 0 0 18px rgba(0, 255, 232, 0.7);
        margin-top: -6px;
      }

      /* Moving face riding the mercury (Devlan with hair) */
      .thermo-face {
        position: absolute;
        left: 50%;
        width: 78px;
        height: 78px;
        border-radius: 50%;
        transform: translateX(-50%);
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent; /* no black */
        border: none; /* no white ring */
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.9);
        bottom: 20px; /* JS will adjust based on percentage */
        transition: bottom 0.6s ease-out;
        z-index: 2;
      }

      .thermo-face img {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        object-fit: contain;
      }

      /* Goal face at the top (Devlan bald) */
      .thermo-face-goal {
        position: absolute;
        left: 50%;
        width: 78px;
        height: 78px;
        border-radius: 50%;
        transform: translateX(-50%);
        top: -6px; /* sits right at the top as the goal */
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        border: none; /* no white ring */
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.9);
        z-index: 2;
      }

      .thermo-face-goal img {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        object-fit: contain;
      }

      .thermo-labels {
        font-size: 1.05rem;
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      #thermoCount {
        font-size: 1.3rem;
      }

      #thermoPercent {
        font-size: 1rem;
        opacity: 0.9;
      }

      .thermo-target {
        font-size: 0.9rem;
        opacity: 0.7;
      }

      /* LEADERBOARD */
      .leaderboard-wrapper {
        width: 100%;
        max-width: 720px; /* narrower than page */
        margin: 40px auto 0;
        padding: 18px 16px 22px;
        background: rgba(0, 0, 0, 0.65);
        border-radius: 20px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.8);
      }

      .leaderboard-title {
        text-align: center;
        margin: 0 0 14px;
        font-size: 1.8rem;
        text-transform: uppercase;
        text-shadow: 0 3px 6px rgba(0, 0, 0, 0.4);
      }

      .leaderboard-table-wrapper {
        overflow-x: auto;
      }

      table.leaderboard-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 1.1rem;
      }

      .leaderboard-table thead {
        background: rgba(255, 255, 255, 0.04);
      }

      .leaderboard-table th,
      .leaderboard-table td {
        padding: 8px 10px;
        text-align: left;
      }

      .leaderboard-table th {
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.95rem;
        letter-spacing: 0.04em;
      }

      .leaderboard-table tbody tr:nth-child(odd) {
        background: rgba(0, 0, 0, 0.35);
      }

      .leaderboard-table tbody tr:nth-child(even) {
        background: rgba(255, 255, 255, 0.02);
      }

      .leaderboard-rank-col {
        width: 60px;
      }

      .leaderboard-wallet-col {
        width: 50%;
        font-family: monospace;
      }

      .leaderboard-votes-col {
        text-align: right;
      }

      .leaderboard-empty {
        text-align: center;
        padding: 10px 0;
        opacity: 0.9;
      }

      .leaderboard-row-me {
        outline: 2px solid rgba(0, 255, 232, 0.8);
        outline-offset: -1px;
      }

      @media (max-width: 600px) {
        .header {
          height: 80px;
        }

        .header-logo {
          height: 60px;
        }

        .connect-btn {
          width: 220px;
          height: 70px;
        }

        h1 {
          margin-top: 40px;
        }

        .connect-hover-text {
          font-size: 1.6rem;
        }

        .vote-stats {
          font-size: 1.2rem;
        }

        .vote-btn,
        .no-votes-text {
          font-size: 1.4rem;
        }

        .poh-status {
          font-size: 1.2rem;
        }

        .voting-layout {
          flex-direction: column;
          align-items: center;
        }

        .thermo-wrapper {
          width: 220px;
        }

        .leaderboard-wrapper {
          max-width: 100%;
          padding: 14px 10px 18px;
        }
      }

      /* helper: hidden class */
      .hidden {
        display: none !important;
      }
    </style>
  </head>

  <body>
    <div class="page">
      <header class="header">
        <a
          href="https://www.davydonothing.com"
          target="_blank"
          rel="noopener noreferrer"
          class="header-link"
        >
          <img
            src="assets/images/dnlogo2.png"
            alt="DN Brotato logo"
            class="header-logo"
          />
        </a>
      </header>

      <h1>DN Voting Platform</h1>

      <!-- STATE 1: CONNECT (shown initially) -->
      <div class="connect-wrapper" id="connectSection">
        <button
          class="connect-btn"
          id="connectWalletButton"
          aria-label="Connect Wallet"
        ></button>

        <div class="connect-hover-text">
          <p>Connect your wallet to vote on SERIOUS topics</p>
        </div>
      </div>

      <!-- STATE 2: NOT POH VERIFIED -->
      <div class="not-verified hidden" id="notVerifiedSection">
        <p>This wallet is not PoH verified yet.</p>
        <a
          href="#"
          target="_blank"
          rel="noopener noreferrer"
          class="verify-button"
          id="verifyLink"
        >
          Verify Here
        </a>
      </div>

      <!-- STATE 3: VOTING + CLAIM STATION -->
      <div class="voting-station hidden" id="votingSection">
        <div class="voting-layout">
          <!-- LEFT: Vote Thermometer -->
          <div class="thermo-wrapper">
            <div class="thermo-title">Vote Heat</div>

            <div class="thermo-body">
              <div class="thermo-column">
                <div class="thermo-mercury" id="thermoMercury"></div>
              </div>
              <div class="thermo-bulb"></div>

              <!-- Goal face (Devlan bald) at the top -->
              <div class="thermo-face-goal">
                <img src="assets/images/DevlanBald.png" alt="Devlan bald" />
              </div>

              <!-- Moving face (Devlan with hair) following the mercury -->
              <div class="thermo-face" id="thermoFace">
                <img src="assets/images/Devlan.png" alt="Devlan face" />
              </div>
            </div>

            <div class="thermo-labels">
              <div id="thermoCount">0</div>
              <div id="thermoPercent">0% to target</div>
              <div class="thermo-target" id="thermoTarget">
                Target: 100,000 votes
              </div>
            </div>
          </div>

          <!-- RIGHT: Voting + Claim content -->
          <div class="voting-content">
            <div class="voting-title">Voting station</div>

            <!-- PoH status line -->
            <div class="poh-status">
              <span class="poh-status-label">Proof of Humanity verified: </span>
              <span class="poh-status-yes">Yes</span>
            </div>

            <!-- Rank line -->
            <div class="rank-line">
              <span class="rank-label" id="rankLabel"
                >Your rank = #– Not ranked yet</span
              >
            </div>

            <!-- Vote stats -->
            <div class="vote-stats">
              <div class="vote-stat-row">
                <div class="vote-stat-label">Total votes</div>
                <div class="vote-stat-value" id="totalVotes">0</div>
              </div>

              <div class="vote-stat-row">
                <div class="vote-stat-label">Your total votes</div>
                <div class="vote-stat-value" id="userTotalVotes">0</div>
              </div>

              <div class="vote-stat-row">
                <div class="vote-stat-label">Votes today</div>
                <div class="vote-stat-value" id="votesToday">0/10</div>
              </div>
            </div>

            <div class="vote-action" id="voteAction">
              <!-- JS will drop the image Vote button or "Come back later" text here -->
            </div>

            <!-- CLAIM STATION -->
            <div class="claim-section" id="claimSection">
              <div class="claim-title">Claim station</div>

              <div class="claim-stats">
                <div class="claim-stat-row">
                  <div class="claim-stat-label">Claimable votes</div>
                  <div class="claim-stat-value" id="claimableVotes">0</div>
                </div>
                <div class="claim-stat-row">
                  <div class="claim-stat-label">Claims today</div>
                  <div class="claim-stat-value" id="claimsToday">0/10</div>
                </div>
              </div>

              <div class="claim-action" id="claimAction">
                <!-- JS will drop claim button or hint text here -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- LEADERBOARD (bottom, full-width-ish) -->
      <div class="leaderboard-wrapper" id="leaderboardSection">
        <div class="leaderboard-title">Top Voters</div>
        <div class="leaderboard-table-wrapper">
          <table class="leaderboard-table">
            <thead>
              <tr>
                <th class="leaderboard-rank-col">Rank</th>
                <th class="leaderboard-wallet-col">Wallet</th>
                <th class="leaderboard-votes-col">Total Votes</th>
              </tr>
            </thead>
            <tbody id="leaderboardBody">
              <tr>
                <td colspan="3" class="leaderboard-empty">
                  No votes yet. Be the first Brotato.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      // ---------- CONSTANTS ----------
      const VOTE_CONTRACT_ADDRESS =
        "0xF2e347e7E7D86Ec1CD90914514b4Ee7dC09cB2bD";
      const CLAIM_CONTRACT_ADDRESS =
        "0x27d9afD099d947B6D04d2713c2fD357495e13fcd";
      const LINEA_SEPOLIA_CHAIN_ID = "0xe705"; // 59141 in hex

      // Voting contract ABI (minimal needed)
      const VOTING_ABI = [
        "function maxVotesPerDay() view returns (uint8)",
        "function votesLeftToday(address user) view returns (uint8)",
        "function totalVotesOf(address user) view returns (uint256)",
        "function totalVotesGlobal() view returns (uint256)",
        "function voteFeeWei() view returns (uint256)",
        "function vote() external payable",
        "event Voted(address indexed voter, uint64 indexed dayIndex, uint8 votesToday, uint256 userTotalVotes, uint256 totalVotesGlobal)"
      ];

      // Claim contract ABI (minimal needed)
      const CLAIM_ABI = [
        "function maxClaimsPerDay() view returns (uint8)",
        "function ethPerVoteWei() view returns (uint256)",
        "function claimableVotes(address user) view returns (uint256)",
        "function dailyClaimsLeft(address user) view returns (uint8)",
        "function getUserClaimInfo(address user) view returns (uint64 dayIndex, uint8 claimsToday, uint256 votesClaimed, uint256 totalVotes, uint256 votesAvailable, uint8 claimsLeftToday)",
        "function claim() external"
      ];

      const RANK_LABELS = [
        "Brotato Overlord",
        "Shaven Prophet",
        "Razor’s Edge",
        "Lather Lord",
        "Clipper Commander",
        "Buzzcut Baron",
        "Fade Fanatic",
        "Trim Tyrant",
        "Comb-Over Casualty",
        "Hairline Hero",
        "Follicle Fighter",
        "Scalp Scout",
        "Snip Soldier",
        "Mane Menace",
        "Brush Bandit",
        "Split-End Survivor",
        "Gel Goblin",
        "Foam Footsoldier",
        "Comb Crusader",
        "Lint Lurker"
      ];

      // Thermometer tuning
      const TARGET_VOTES = 100000; // you can later change to 5000 if you want
      const MERCURY_OFFSET = 7; // mercury slightly behind Devlan
      const MIN_BOTTOM = 20; // your calibrated 0% position
      const MAX_BOTTOM = 340; // top

      // ---------- DOM ELEMENTS ----------
      const connectSection = document.getElementById("connectSection");
      const notVerifiedSection = document.getElementById("notVerifiedSection");
      const votingSection = document.getElementById("votingSection");
      const voteAction = document.getElementById("voteAction");
      const claimAction = document.getElementById("claimAction");
      const rankLabel = document.getElementById("rankLabel");

      const totalVotesEl = document.getElementById("totalVotes");
      const userTotalVotesEl = document.getElementById("userTotalVotes");
      const votesTodayEl = document.getElementById("votesToday");

      const claimableVotesEl = document.getElementById("claimableVotes");
      const claimsTodayEl = document.getElementById("claimsToday");

      const connectWalletButton = document.getElementById("connectWalletButton");

      // Thermometer elements
      const thermoMercury = document.getElementById("thermoMercury");
      const thermoFace = document.getElementById("thermoFace");
      const thermoCount = document.getElementById("thermoCount");
      const thermoPercent = document.getElementById("thermoPercent");
      const thermoTarget = document.getElementById("thermoTarget");

      // Leaderboard
      const leaderboardBody = document.getElementById("leaderboardBody");

      // ---------- ETHERS STATE ----------
      let provider = null;
      let signer = null;
      let voteContract = null;
      let claimContract = null;
      let connectedAddress = null;

      // ---------- HELPERS ----------
      function bnToNumber(bn) {
        if (!bn) return 0;
        try {
          return Number(bn.toString());
        } catch {
          return 0;
        }
      }

      function shortenAddress(addr) {
        if (!addr) return "";
        return addr.slice(0, 6) + "..." + addr.slice(-4);
      }

      function setHidden(el, hidden) {
        if (!el) return;
        if (hidden) el.classList.add("hidden");
        else el.classList.remove("hidden");
      }

      // ---------- UI STATE ----------
      function showNotVerified() {
        setHidden(connectSection, true);
        setHidden(votingSection, true);
        setHidden(notVerifiedSection, false);
      }

      function showVotingStation() {
        setHidden(connectSection, true);
        setHidden(notVerifiedSection, true);
        setHidden(votingSection, false);
      }

      // ---------- THERMOMETER ----------
      function updateThermometer(totalVotes) {
        const pctRaw =
          TARGET_VOTES > 0 ? (totalVotes / TARGET_VOTES) * 100 : 0;
        const pct = Math.max(0, Math.min(pctRaw, 100));

        const mercuryPct = Math.max(
          0,
          Math.min(pct - MERCURY_OFFSET, 100)
        );

        if (thermoMercury) {
          thermoMercury.style.height = mercuryPct + "%";
        }
        if (thermoCount) {
          thermoCount.textContent = totalVotes.toLocaleString();
        }
        if (thermoPercent) {
          thermoPercent.textContent = `${pct.toFixed(1)}% to target`;
        }
        if (thermoTarget) {
          thermoTarget.textContent = `Target: ${TARGET_VOTES.toLocaleString()} votes`;
        }

        if (thermoFace) {
          const t = pct / 100;
          const eased = Math.pow(t, 0.6);
          const faceBottom =
            MIN_BOTTOM + (MAX_BOTTOM - MIN_BOTTOM) * eased;
          thermoFace.style.bottom = `${faceBottom}px`;
        }
      }

      // ---------- DATA LOADERS ----------
      async function loadVoteStats(address) {
        if (!voteContract || !address) return;

        const [
          totalVotesGlobalBN,
          userTotalVotesBN,
          votesLeftTodayBN,
          maxVotesPerDayBN
        ] = await Promise.all([
          voteContract.totalVotesGlobal(),
          voteContract.totalVotesOf(address),
          voteContract.votesLeftToday(address),
          voteContract.maxVotesPerDay()
        ]);

        const totalVotesGlobal = bnToNumber(totalVotesGlobalBN);
        const userTotalVotes = bnToNumber(userTotalVotesBN);
        const votesLeftToday = bnToNumber(votesLeftTodayBN);
        const maxVotesPerDay = bnToNumber(maxVotesPerDayBN);

        const votesUsedToday = Math.max(
          0,
          maxVotesPerDay - votesLeftToday
        );

        totalVotesEl.textContent = totalVotesGlobal.toLocaleString();
        userTotalVotesEl.textContent = userTotalVotes.toLocaleString();
        votesTodayEl.textContent = `${votesLeftToday}/${maxVotesPerDay}`;

        updateThermometer(totalVotesGlobal);
        updateVoteAction(votesLeftToday, maxVotesPerDay);
      }

      function updateVoteAction(votesLeftToday, maxVotesPerDay) {
        voteAction.innerHTML = "";

        if (votesLeftToday > 0) {
          const btn = document.createElement("button");
          btn.className = "vote-btn";
          btn.setAttribute("aria-label", "Vote");
          btn.addEventListener("click", async () => {
            try {
              await voteOnChain();
            } catch (err) {
              console.error("Vote error:", err);
              alert("Vote failed. Check console for details.");
            }
          });
          voteAction.appendChild(btn);
        } else {
          const p = document.createElement("p");
          p.className = "no-votes-text";
          p.textContent =
            "You’ve used all votes for now. Come back later.";
          voteAction.appendChild(p);
        }
      }

      async function loadClaimInfo(address) {
        if (!claimContract || !address) return;

        const [info, maxClaimsPerDayBN] = await Promise.all([
          claimContract.getUserClaimInfo(address),
          claimContract.maxClaimsPerDay()
        ]);

        // info is both array-like and has named props (depending on ethers)
        const claimsToday = bnToNumber(info.claimsToday ?? info[1]);
        const votesAvailable = bnToNumber(
          info.votesAvailable ?? info[4]
        );
        const claimsLeftToday = bnToNumber(
          info.claimsLeftToday ?? info[5]
        );
        const maxClaimsPerDay = bnToNumber(maxClaimsPerDayBN);

        claimableVotesEl.textContent = votesAvailable.toString();
        claimsTodayEl.textContent = `${claimsToday}/${maxClaimsPerDay}`;

        claimAction.innerHTML = "";

        if (votesAvailable > 0 && claimsLeftToday > 0) {
          const btn = document.createElement("button");
          btn.className = "claim-btn";
          btn.setAttribute("aria-label", "Claim");
          btn.addEventListener("click", async () => {
            try {
              await claimOnChain();
            } catch (err) {
              console.error("Claim error:", err);
              alert("Claim failed. Check console for details.");
            }
          });
          claimAction.appendChild(btn);
        } else if (votesAvailable === 0) {
          const p = document.createElement("p");
          p.className = "no-claims-text";
          p.textContent = "No claimable votes yet. Go cast some votes.";
          claimAction.appendChild(p);
        } else {
          const p = document.createElement("p");
          p.className = "no-claims-text";
          p.textContent =
            "You’ve used all claims for now. Come back later.";
          claimAction.appendChild(p);
        }
      }

      async function loadLeaderboard(currentAddr) {
        if (!voteContract || !provider) return;

        const iface = new ethers.utils.Interface(VOTING_ABI);
        const eventFragment = iface.getEvent("Voted");
        const topicVoted = iface.getEventTopic(eventFragment);

        const currentBlock = await provider.getBlockNumber();
        const fromBlock = Math.max(0, currentBlock - 50000); // recent window

        let logs = [];
        try {
          logs = await provider.getLogs({
            address: VOTE_CONTRACT_ADDRESS,
            topics: [topicVoted],
            fromBlock,
            toBlock: "latest"
          });
        } catch (err) {
          console.error("getLogs error:", err);
          return;
        }

        const totals = new Map();

        for (const log of logs) {
          try {
            const parsed = iface.parseLog(log);
            const voter = parsed.args.voter;
            const userTotalVotes = bnToNumber(parsed.args.userTotalVotes);

            const prev = totals.get(voter) || 0;
            // Use the MAX seen so we don't overcount
            totals.set(voter, Math.max(prev, userTotalVotes));
          } catch (err) {
            console.warn("parseLog failed:", err);
          }
        }

        const entries = Array.from(totals.entries())
          .map(([address, votes]) => ({ address, votes }))
          .sort((a, b) => b.votes - a.votes);

        leaderboardBody.innerHTML = "";

        if (entries.length === 0) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 3;
          td.className = "leaderboard-empty";
          td.textContent =
            "No votes yet. Be the first Brotato.";
          tr.appendChild(td);
          leaderboardBody.appendChild(tr);
          rankLabel.textContent =
            "Your rank = #– Not ranked yet";
          return;
        }

        let myRankIndex = -1;
        const lowerCurrent = currentAddr
          ? currentAddr.toLowerCase()
          : null;

        entries.forEach((entry, index) => {
          const tr = document.createElement("tr");
          const rankTd = document.createElement("td");
          const walletTd = document.createElement("td");
          const votesTd = document.createElement("td");

          rankTd.textContent = "#" + (index + 1).toString();
          walletTd.textContent = shortenAddress(entry.address);
          votesTd.textContent = entry.votes.toLocaleString();

          rankTd.className = "leaderboard-rank-col";
          walletTd.className = "leaderboard-wallet-col";
          votesTd.className = "leaderboard-votes-col";

          if (
            lowerCurrent &&
            entry.address.toLowerCase() === lowerCurrent
          ) {
            myRankIndex = index;
            tr.classList.add("leaderboard-row-me");
          }

          tr.appendChild(rankTd);
          tr.appendChild(walletTd);
          tr.appendChild(votesTd);
          leaderboardBody.appendChild(tr);
        });

        if (myRankIndex >= 0) {
          const rankNum = myRankIndex + 1;
          const labelIndex = Math.min(
            myRankIndex,
            RANK_LABELS.length - 1
          );
          const label = RANK_LABELS[labelIndex];
          rankLabel.textContent = `Your rank = #${rankNum} - ${label}`;
        } else {
          rankLabel.textContent =
            "Your rank = #– Not ranked yet";
        }
      }

      // ---------- ON-CHAIN ACTIONS ----------
      async function voteOnChain() {
        if (!voteContract || !signer) throw new Error("Not ready");

        const feeBN = await voteContract.voteFeeWei();
        const tx = await voteContract.vote({ value: feeBN });
        console.log("Vote tx sent:", tx.hash);
        await tx.wait();
        console.log("Vote tx confirmed");

        await Promise.all([
          loadVoteStats(connectedAddress),
          loadClaimInfo(connectedAddress),
          loadLeaderboard(connectedAddress)
        ]);
      }

      async function claimOnChain() {
        if (!claimContract || !signer) throw new Error("Not ready");

        const tx = await claimContract.claim();
        console.log("Claim tx sent:", tx.hash);
        await tx.wait();
        console.log("Claim tx confirmed");

        await Promise.all([
          loadClaimInfo(connectedAddress),
          loadLeaderboard(connectedAddress)
        ]);
      }

      // ---------- PoH STUB ----------
      async function checkPohStub(walletAddress) {
        console.log("Checking PoH (stub) for", walletAddress);
        // Always true for now
        return true;
      }

      // ---------- CONNECT FLOW ----------
      async function connectAndInit() {
        try {
          if (typeof window.ethereum === "undefined") {
            alert(
              "No wallet detected. Please install MetaMask or a compatible wallet."
            );
            return;
          }

          provider = new ethers.providers.Web3Provider(
            window.ethereum,
            "any"
          );

          await provider.send("eth_requestAccounts", []);
          signer = provider.getSigner();
          const address = await signer.getAddress();
          connectedAddress = address;
          console.log("Connected:", address);

          const network = await provider.getNetwork();
          const chainHex = "0x" + network.chainId.toString(16);

          if (chainHex !== LINEA_SEPOLIA_CHAIN_ID) {
            try {
              await window.ethereum.request({
                method: "wallet_switchEthereumChain",
                params: [{ chainId: LINEA_SEPOLIA_CHAIN_ID }]
              });
            } catch (switchErr) {
              console.error("Switch network error:", switchErr);
              alert(
                "Please switch your wallet network to Linea Sepolia testnet."
              );
              return;
            }
          }

          voteContract = new ethers.Contract(
            VOTE_CONTRACT_ADDRESS,
            VOTING_ABI,
            signer
          );
          claimContract = new ethers.Contract(
            CLAIM_CONTRACT_ADDRESS,
            CLAIM_ABI,
            signer
          );

          const isVerified = await checkPohStub(address);

          if (!isVerified) {
            showNotVerified();
            return;
          }

          showVotingStation();

          await Promise.all([
            loadVoteStats(address),
            loadClaimInfo(address),
            loadLeaderboard(address)
          ]);
        } catch (err) {
          console.error("Connect/init error:", err);
          alert("Could not connect wallet. Check console for details.");
        }
      }

      connectWalletButton.addEventListener("click", () => {
        connectAndInit();
      });
    </script>
  </body>
</html>
