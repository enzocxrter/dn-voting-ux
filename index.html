<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Dn Brotato Taterz Farm</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Dn Brotato Taterz Farm" />

    <link rel="icon" href="fabicon.png" />

    <style>
      @font-face {
        font-family: "OverstreetBibleBold";
        src: url("assets/fonts/overstreetbiblebold.ttf") format("truetype");
        font-weight: normal;
        font-style: normal;
        font-display: swap;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "OverstreetBibleBold", system-ui, -apple-system,
          BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: #ffffff;
        background: url("assets/images/background2.png") center center / cover
          no-repeat fixed;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .page {
        width: 100%;
        max-width: 1200px;
        padding: 20px 16px 60px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      /* HEADER / LOGO BAR */
      .header {
        width: 100%;
        height: 100px;
        background: transparent;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0;
      }

      .header-link {
        display: inline-block;
      }

      .header-logo {
        height: 80px;
        width: auto;
        transition: transform 0.3s ease;
      }

      .header-logo:hover {
        transform: scale(1.05);
      }

      /* TITLE */
      h1 {
        margin: 60px 0 40px;
        text-align: center;
        font-size: clamp(2.5rem, 5vw, 4.5rem);
        line-height: 1.1;
        text-transform: uppercase;
        text-shadow: 0 3px 6px rgba(0, 0, 0, 0.4);
        color: #000000; /* black title */
      }

      /* CONNECT SECTION */
      .connect-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
      }

      .connect-btn {
        border: none;
        padding: 0;
        background: transparent;
        cursor: pointer;
        display: block;
        width: 260px;
        height: 80px;
        background-image: url("assets/images/connect.png");
        background-position: center;
        background-repeat: no-repeat;
        background-size: contain;
        transform: scale(1);
        transition:
          transform 0.15s ease-out,
          background-image 0.15s ease-out;
      }

      .connect-btn:hover {
        background-image: url("assets/images/connecthover.png");
        transform: scale(1.15);
      }

      .connect-btn:active {
        transform: scale(0.98);
      }

      /* Hover text under connect */
      .connect-hover-text {
        margin-top: 16px;
        width: 100%;
        max-width: 600px;
        text-align: center;
        color: #f5f5f5;
        font-size: 2rem;
        opacity: 0;
        transform: translateY(8px);
        transition:
          opacity 0.2s ease-out,
          transform 0.2s ease-out;
        pointer-events: none;
      }

      .connect-wrapper:hover .connect-hover-text {
        opacity: 1;
        transform: translateY(0);
      }

      /* TOP SECTION: THERMO + VOTE/CLAIM */
      .top-layout {
        margin-top: 30px;
        width: 100%;
        display: flex;
        justify-content: center;
        gap: 24px;
        align-items: flex-start;
      }

      /* LEFT SIDE: VOTE THERMOMETER */
      .thermo-wrapper {
        width: 200px;
        padding: 16px 12px 20px;
        background: rgba(0, 0, 0, 0.6);
        border-radius: 20px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.7);
        text-align: center;
      }

      .thermo-title {
        font-size: 1.4rem;
        text-transform: uppercase;
        margin-bottom: 12px;
      }

      .thermo-body {
        position: relative;
        width: 90px;
        height: 460px; /* tall thermometer */
        margin: 0 auto 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .thermo-column {
        position: relative;
        width: 36px;
        height: 340px;
        margin-top: 6px;
        border-radius: 999px;
        border: 4px solid rgba(255, 255, 255, 0.9);
        overflow: hidden;
        background: linear-gradient(
          to top,
          rgba(255, 255, 255, 0.12),
          rgba(255, 255, 255, 0.25)
        );
      }

      .thermo-mercury {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 0%; /* JS updates this */
        background: linear-gradient(
          to top,
          #12ceec,
          #00ffe8
        );
        box-shadow: 0 0 12px rgba(0, 255, 232, 0.8);
        transition: height 0.6s ease-out;
      }

      .thermo-bulb {
        width: 56px;
        height: 56px;
        border-radius: 999px;
        border: 4px solid rgba(255, 255, 255, 0.95);
        background: radial-gradient(
          circle at 30% 30%,
          #00ffe8,
          #12ceec
        );
        box-shadow: 0 0 18px rgba(0, 255, 232, 0.7);
        margin-top: -6px;
      }

      /* Moving face riding the mercury (Devlan with hair) */
      .thermo-face {
        position: absolute;
        left: 50%;
        width: 78px;
        height: 78px;
        border-radius: 50%;
        transform: translateX(-50%);
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        border: none;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.9);
        bottom: 20px; /* JS will adjust based on percentage */
        transition: bottom 0.6s ease-out;
        z-index: 2;
      }

      .thermo-face img {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        object-fit: contain;
      }

      /* Goal face at the top (Devlan bald) */
      .thermo-face-goal {
        position: absolute;
        left: 50%;
        width: 78px;
        height: 78px;
        border-radius: 50%;
        transform: translateX(-50%);
        top: -6px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        border: none;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.9);
        z-index: 2;
      }

      .thermo-face-goal img {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        object-fit: contain;
      }

      .thermo-labels {
        font-size: 1.05rem;
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      #thermoCount {
        font-size: 1.3rem;
      }

      #thermoPercent {
        font-size: 1rem;
        opacity: 0.9;
      }

      .thermo-target {
        font-size: 0.9rem;
        opacity: 0.7;
      }

      /* RIGHT COLUMN: VOTE + CLAIM BOXES */
      .right-column {
        flex: 1;
        max-width: 540px;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      /* VOTING STATION */
      .voting-station {
        width: 100%;
        text-align: center;
        color: #ffffff;
        background: rgba(0, 0, 0, 0.55);
        border-radius: 18px;
        padding: 18px 18px 22px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.7);
      }

      .voting-title {
        font-size: clamp(2rem, 4vw, 3rem);
        text-transform: uppercase;
        margin-bottom: 12px;
        text-shadow: 0 3px 6px rgba(0, 0, 0, 0.5);
      }

      /* PoH status + Rank line */
      .poh-status {
        margin-bottom: 8px;
        font-size: 1.4rem;
      }

      .poh-status-label {
        color: #ffffff;
      }

      .poh-status-yes {
        color: #00ffe8;
        text-shadow: 0 0 4px #000, 0 0 10px #000;
      }

      .rank-status {
        margin-bottom: 18px;
      }

      .rank-pill {
        display: inline-block;
        padding: 6px 14px;
        border-radius: 999px;
        background: rgba(0, 0, 0, 0.7);
        color: #00ffe8;
        font-size: 1.4rem;
        text-shadow: 0 0 4px #000, 0 0 10px #000;
      }

      .vote-stats {
        display: flex;
        flex-direction: column;
        gap: 12px;
        font-size: 1.4rem;
        margin-bottom: 20px;
      }

      .vote-stat-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(0, 0, 0, 0.45);
        padding: 10px 16px;
        border-radius: 10px;
      }

      .vote-stat-label {
        text-align: left;
      }

      .vote-stat-value {
        text-align: right;
      }

      /* Vote action area */
      .vote-action {
        margin-top: 10px;
        font-size: 1.6rem;
      }

      /* Image-based VOTE button */
      .vote-btn {
        border: none;
        padding: 0;
        background: transparent;
        cursor: pointer;
        display: inline-block;
        width: 220px;
        height: 70px;
        background-image: url("assets/images/vote.png");
        background-position: center;
        background-repeat: no-repeat;
        background-size: contain;
        transform: scale(1);
        transition:
          transform 0.15s ease-out,
          background-image 0.15s ease-out;
      }

      .vote-btn:hover {
        background-image: url("assets/images/votehover.png");
        transform: scale(1.15);
      }

      .vote-btn:active {
        transform: scale(0.98);
      }

      .no-votes-text {
        font-size: 1.6rem;
        opacity: 0.9;
      }

      /* CLAIM STATION (same box column as vote, just below) */
      .claim-station {
        width: 100%;
        text-align: center;
        color: #ffffff;
        background: rgba(0, 0, 0, 0.55);
        border-radius: 18px;
        padding: 18px 18px 22px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.7);
      }

      .claim-title {
        font-size: clamp(1.8rem, 3vw, 2.4rem);
        text-transform: uppercase;
        margin-bottom: 12px;
        text-shadow: 0 3px 6px rgba(0, 0, 0, 0.5);
      }

      .claim-stats {
        display: flex;
        flex-direction: column;
        gap: 12px;
        font-size: 1.4rem;
        margin-bottom: 20px;
      }

      .claim-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(0, 0, 0, 0.45);
        padding: 10px 16px;
        border-radius: 10px;
      }

      .claim-label {
        text-align: left;
      }

      .claim-value {
        text-align: right;
      }

      .claim-action {
        margin-top: 10px;
        font-size: 1.6rem;
      }

      .claim-btn {
        border: none;
        padding: 0;
        background: transparent;
        cursor: pointer;
        display: inline-block;
        width: 220px;
        height: 70px;
        background-image: url("assets/images/claim.png");
        background-position: center;
        background-repeat: no-repeat;
        background-size: contain;
        transform: scale(1);
        transition:
          transform 0.15s ease-out,
          background-image 0.15s ease-out;
      }

      .claim-btn:hover {
        background-image: url("assets/images/claimhover.png");
        transform: scale(1.15);
      }

      .claim-btn:active {
        transform: scale(0.98);
      }

      .no-claims-text {
        font-size: 1.6rem;
        opacity: 0.9;
      }

      /* Not PoH verified panel */
      .not-verified {
        margin-top: 24px;
        text-align: center;
        font-size: 1.4rem;
      }

      .verify-button {
        margin-top: 12px;
        display: inline-block;
        padding: 10px 24px;
        border-radius: 999px;
        background: #000000;
        color: #ffffff;
        text-decoration: none;
        text-transform: uppercase;
        font-size: 1.2rem;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.6);
      }

      /* LEADERBOARD */
      .leaderboard {
        margin: 40px auto 0;
        width: 100%;
        max-width: 720px; /* narrower than full page */
        background: rgba(0, 0, 0, 0.6);
        border-radius: 18px;
        padding: 18px 18px 24px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.7);
      }

      .leaderboard-title {
        font-size: 1.8rem;
        text-transform: uppercase;
        margin-bottom: 12px;
        text-align: center;
        text-shadow: 0 3px 6px rgba(0, 0, 0, 0.5);
      }

      .leaderboard-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 1.1rem;
      }

      .leaderboard-table th,
      .leaderboard-table td {
        padding: 8px 10px;
        text-align: left;
      }

      .leaderboard-table thead {
        background: rgba(255, 255, 255, 0.08);
      }

      .leaderboard-table tbody tr:nth-child(even) {
        background: rgba(255, 255, 255, 0.03);
      }

      .leaderboard-table tbody tr:nth-child(odd) {
        background: rgba(0, 0, 0, 0.15);
      }

      .leaderboard-wallet {
        font-family: monospace;
        font-size: 0.98rem;
      }

      .leaderboard-row-current {
        outline: 2px solid #00ffe8;
      }

      @media (max-width: 800px) {
        .top-layout {
          flex-direction: column;
          align-items: center;
        }

        .right-column {
          max-width: 100%;
        }

        .thermo-wrapper {
          width: 220px;
        }
      }

      @media (max-width: 600px) {
        .header {
          height: 80px;
        }

        .header-logo {
          height: 60px;
        }

        .connect-btn {
          width: 220px;
          height: 70px;
        }

        h1 {
          margin-top: 40px;
        }

        .connect-hover-text {
          font-size: 1.6rem;
        }

        .vote-stats,
        .claim-stats {
          font-size: 1.2rem;
        }

        .vote-btn,
        .claim-btn,
        .no-votes-text,
        .no-claims-text {
          font-size: 1.4rem;
        }

        .poh-status {
          font-size: 1.2rem;
        }

        .leaderboard {
          max-width: 100%;
        }
      }

      /* helper: hidden class */
      .hidden {
        display: none !important;
      }
    </style>
  </head>

  <body>
    <div class="page">
      <header class="header">
        <a
          href="https://www.davydonothing.com"
          target="_blank"
          rel="noopener noreferrer"
          class="header-link"
        >
          <img
            src="assets/images/dnlogo2.png"
            alt="DN Brotato logo"
            class="header-logo"
          />
        </a>
      </header>

      <h1>DN Voting Platform</h1>

      <!-- STATE 1: CONNECT (shown initially) -->
      <div class="connect-wrapper" id="connectSection">
        <button
          class="connect-btn"
          id="connectWalletButton"
          aria-label="Connect Wallet"
        ></button>

        <div class="connect-hover-text">
          <p>Connect your wallet to vote on SERIOUS topics</p>
        </div>
      </div>

      <!-- STATE 2: NOT POH VERIFIED -->
      <div class="not-verified hidden" id="notVerifiedSection">
        <p>This wallet is not PoH verified yet.</p>
        <a
          href="#"
          target="_blank"
          rel="noopener noreferrer"
          class="verify-button"
          id="verifyLink"
        >
          Verify Here
        </a>
      </div>

      <!-- STATE 3: TOP LAYOUT (THERMO + VOTE/CLAIM) -->
      <div class="top-layout hidden" id="topLayout">
        <!-- LEFT: Vote Thermometer -->
        <div class="thermo-wrapper">
          <div class="thermo-title">Vote Heat</div>

          <div class="thermo-body">
            <div class="thermo-column">
              <div class="thermo-mercury" id="thermoMercury"></div>
            </div>
            <div class="thermo-bulb"></div>

            <!-- Goal face (Devlan bald) at the top -->
            <div class="thermo-face-goal">
              <img src="assets/images/DevlanBald.png" alt="Devlan bald" />
            </div>

            <!-- Moving face (Devlan with hair) following the mercury -->
            <div class="thermo-face" id="thermoFace">
              <img src="assets/images/Devlan.png" alt="Devlan face" />
            </div>
          </div>

          <div class="thermo-labels">
            <div id="thermoCount">0</div>
            <div id="thermoPercent">0% to target</div>
            <div class="thermo-target" id="thermoTarget">
              Target: 5,000 votes
            </div>
          </div>
        </div>

        <!-- RIGHT: Vote + Claim boxes -->
        <div class="right-column">
          <!-- VOTING STATION -->
          <div class="voting-station" id="votingSection">
            <div class="voting-title">Voting station</div>

            <!-- PoH status line -->
            <div class="poh-status">
              <span class="poh-status-label">Proof of Humanity verified: </span>
              <span class="poh-status-yes">Yes</span>
            </div>

            <!-- Rank line -->
            <div class="rank-status">
              <span class="rank-pill" id="rankText">
                Your rank = #? - Brotato Overlord
              </span>
            </div>

            <div class="vote-stats">
              <div class="vote-stat-row">
                <div class="vote-stat-label">Total votes</div>
                <div class="vote-stat-value" id="totalVotes">0</div>
              </div>

              <div class="vote-stat-row">
                <div class="vote-stat-label">Your total votes</div>
                <div class="vote-stat-value" id="userTotalVotes">0</div>
              </div>

              <div class="vote-stat-row">
                <div class="vote-stat-label">Votes today</div>
                <div class="vote-stat-value" id="votesToday">0/10</div>
              </div>
            </div>

            <div class="vote-action" id="voteAction">
              <!-- JS will drop the Vote button or "Come back later" text here -->
            </div>
          </div>

          <!-- CLAIM STATION -->
          <div class="claim-station" id="claimSection">
            <div class="claim-title">Claim station</div>

            <div class="claim-stats">
              <div class="claim-row">
                <div class="claim-label">Claimable votes</div>
                <div class="claim-value" id="claimableVotes">0</div>
              </div>

              <div class="claim-row">
                <div class="claim-label">Claims today</div>
                <div class="claim-value" id="claimsTodayText">0/10</div>
              </div>
            </div>

            <div class="claim-action" id="claimAction">
              <!-- JS drops Claim button or "nothing to claim" text here -->
            </div>
          </div>
        </div>
      </div>

      <!-- LEADERBOARD (bottom, full-ish width) -->
      <div class="leaderboard hidden" id="leaderboard">
        <div class="leaderboard-title">Top Voters</div>
        <table class="leaderboard-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Wallet</th>
              <th>Total votes</th>
            </tr>
          </thead>
          <tbody id="leaderboardBody">
            <!-- JS populates rows -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Ethers.js v5 UMD -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

    <script>
      (function () {
        const VOTING_ADDRESS =
          "0xF2e347e7E7D86Ec1CD90914514b4Ee7dC09cB2bD";
        const CLAIM_ADDRESS =
          "0x27d9afD099d947B6D04d2713c2fD357495E13fcd";
        const LINEA_SEPOLIA_CHAIN_ID_DEC = 59141;
        const LINEA_SEPOLIA_CHAIN_ID_HEX = "0xe705";

        const VOTING_ABI = [
          "function totalVotesGlobal() view returns (uint256)",
          "function totalVotesOf(address) view returns (uint256)",
          "function votesLeftToday(address) view returns (uint8)",
          "function maxVotesPerDay() view returns (uint8)",
          "function vote() payable"
        ];

        const CLAIM_ABI = [
          "function getUserClaimInfo(address) view returns (uint64,uint8,uint256,uint256,uint256,uint8)",
          "function maxClaimsPerDay() view returns (uint8)",
          "function claim()"
        ];

        const RANK_TITLES = [
          "Brotato Overlord",
          "Spud General",
          "Hashbrown Hero",
          "Tater Titan",
          "Mash Master",
          "Waffle Fry Warlord",
          "Potato Paladin",
          "Starch Sergeant",
          "Golden Chip Chieftain",
          "Do-Nothing Demi-God"
        ];

        const LEADERBOARD_KEY = "davy-voting-leaderboard-v1";

        const connectSection = document.getElementById("connectSection");
        const notVerifiedSection =
          document.getElementById("notVerifiedSection");
        const topLayout = document.getElementById("topLayout");
        const leaderboardEl = document.getElementById("leaderboard");

        const connectWalletButton =
          document.getElementById("connectWalletButton");

        // Voting UI elements
        const totalVotesEl = document.getElementById("totalVotes");
        const userTotalVotesEl =
          document.getElementById("userTotalVotes");
        const votesTodayEl = document.getElementById("votesToday");
        const voteAction = document.getElementById("voteAction");

        // Claim UI elements
        const claimableVotesEl =
          document.getElementById("claimableVotes");
        const claimsTodayTextEl =
          document.getElementById("claimsTodayText");
        const claimAction = document.getElementById("claimAction");

        // Thermometer elements
        const thermoMercury = document.getElementById("thermoMercury");
        const thermoFace = document.getElementById("thermoFace");
        const thermoCount = document.getElementById("thermoCount");
        const thermoPercent = document.getElementById("thermoPercent");
        const thermoTarget = document.getElementById("thermoTarget");

        // Rank UI
        const rankTextEl = document.getElementById("rankText");

        // Leaderboard table body
        const leaderboardBody =
          document.getElementById("leaderboardBody");

        const TARGET_VOTES = 5000; // new realistic target
        let provider = null;
        let signer = null;
        let votingContract = null;
        let claimContract = null;
        let currentAddress = null;

        // ---------- Local Leaderboard Helpers ----------

        function loadLeaderboard() {
          try {
            const raw = localStorage.getItem(LEADERBOARD_KEY);
            if (!raw) return [];
            const parsed = JSON.parse(raw);
            if (!Array.isArray(parsed)) return [];
            return parsed;
          } catch (e) {
            console.error("Error loading leaderboard from localStorage", e);
            return [];
          }
        }

        function saveLeaderboard(list) {
          try {
            localStorage.setItem(
              LEADERBOARD_KEY,
              JSON.stringify(list)
            );
          } catch (e) {
            console.error("Error saving leaderboard to localStorage", e);
          }
        }

        function upsertLeaderboardEntry(address, totalVotes) {
          if (!address) return;
          let list = loadLeaderboard();
          const addrLower = address.toLowerCase();
          const existingIndex = list.findIndex(
            (e) => e.address.toLowerCase() === addrLower
          );
          if (existingIndex >= 0) {
            list[existingIndex].totalVotes = totalVotes;
          } else {
            list.push({ address, totalVotes });
          }
          list.sort((a, b) => b.totalVotes - a.totalVotes);
          // keep top 50 only
          if (list.length > 50) list = list.slice(0, 50);
          saveLeaderboard(list);
          return list;
        }

        function shortAddress(addr) {
          if (!addr || addr.length < 10) return addr || "";
          return addr.slice(0, 6) + "..." + addr.slice(-4);
        }

        function renderLeaderboard(currentAddr) {
          const list = loadLeaderboard();
          leaderboardBody.innerHTML = "";
          if (!list.length) {
            const tr = document.createElement("tr");
            const td = document.createElement("td");
            td.colSpan = 3;
            td.textContent = "No votes yet. Be the first Brotato.";
            tr.appendChild(td);
            leaderboardBody.appendChild(tr);
            return;
          }
          const currentLower = currentAddr
            ? currentAddr.toLowerCase()
            : "";

          list.forEach((entry, index) => {
            const tr = document.createElement("tr");
            if (
              currentLower &&
              entry.address.toLowerCase() === currentLower
            ) {
              tr.classList.add("leaderboard-row-current");
            }

            const rankTd = document.createElement("td");
            rankTd.textContent = index + 1;

            const walletTd = document.createElement("td");
            walletTd.textContent = shortAddress(entry.address);
            walletTd.className = "leaderboard-wallet";

            const votesTd = document.createElement("td");
            votesTd.textContent = entry.totalVotes.toString();

            tr.appendChild(rankTd);
            tr.appendChild(walletTd);
            tr.appendChild(votesTd);
            leaderboardBody.appendChild(tr);
          });
        }

        function getRankForWallet(addr) {
          if (!addr) return null;
          const list = loadLeaderboard();
          const lower = addr.toLowerCase();
          const idx = list.findIndex(
            (e) => e.address.toLowerCase() === lower
          );
          if (idx === -1) return null;
          return idx + 1; // 1-based
        }

        function updateRankText(addr) {
          const rank = getRankForWallet(addr);
          if (!rank) {
            rankTextEl.textContent =
              "Your rank = ? - Certified Brotato";
            return;
          }
          const title =
            RANK_TITLES[rank - 1] || "Certified Brotato";
          rankTextEl.textContent = `Your rank = #${rank} - ${title}`;
        }

        // ---------- Thermometer ----------

        function updateThermometer(totalVotes) {
          const pctRaw =
            TARGET_VOTES > 0
              ? (totalVotes / TARGET_VOTES) * 100
              : 0;
          const pct = Math.max(0, Math.min(pctRaw, 100));

          const MERCURY_OFFSET = 7;
          const mercuryPct = Math.max(
            0,
            Math.min(pct - MERCURY_OFFSET, 100)
          );

          if (thermoMercury) {
            thermoMercury.style.height = mercuryPct + "%";
          }
          if (thermoCount) {
            thermoCount.textContent =
              (totalVotes || 0).toLocaleString();
          }
          if (thermoPercent) {
            thermoPercent.textContent = `${pct.toFixed(
              1
            )}% to target`;
          }
          if (thermoTarget) {
            thermoTarget.textContent = `Target: ${TARGET_VOTES.toLocaleString()} votes`;
          }

          if (thermoFace) {
            const MIN_BOTTOM = 20;
            const MAX_BOTTOM = 340;
            const t = pct / 100;
            const eased = Math.pow(t, 0.6);
            const faceBottom =
              MIN_BOTTOM +
              (MAX_BOTTOM - MIN_BOTTOM) * eased;
            thermoFace.style.bottom = `${faceBottom}px`;
          }
        }

        // ---------- UI Update Helpers ----------

        function updateVotingUI({
          totalVotesGlobal,
          userTotalVotes,
          votesLeftToday,
          maxVotesPerDay
        }) {
          totalVotesEl.textContent =
            (totalVotesGlobal || 0).toLocaleString();
          userTotalVotesEl.textContent =
            (userTotalVotes || 0).toLocaleString();

          const left =
            typeof votesLeftToday === "number"
              ? votesLeftToday
              : 0;
          const max =
            typeof maxVotesPerDay === "number"
              ? maxVotesPerDay
              : 10;
          votesTodayEl.textContent = `${left}/${max}`;

          voteAction.innerHTML = "";
          if (left > 0) {
            const btn = document.createElement("button");
            btn.className = "vote-btn";
            btn.setAttribute("aria-label", "Vote");
            btn.addEventListener("click", onVoteClick);
            voteAction.appendChild(btn);
          } else {
            const p = document.createElement("p");
            p.className = "no-votes-text";
            p.textContent =
              "You’ve used all votes for now. Come back later.";
            voteAction.appendChild(p);
          }
        }

        function updateClaimUI({
          votesAvailable,
          claimsToday,
          claimsLeftToday,
          maxClaimsPerDay
        }) {
          const available =
            typeof votesAvailable === "number"
              ? votesAvailable
              : 0;
          const leftToday =
            typeof claimsLeftToday === "number"
              ? claimsLeftToday
              : 0;
          const maxClaims =
            typeof maxClaimsPerDay === "number"
              ? maxClaimsPerDay
              : 10;
          const usedToday = maxClaims - leftToday;

          claimableVotesEl.textContent =
            available.toLocaleString();
          claimsTodayTextEl.textContent = `${usedToday}/${maxClaims}`;

          claimAction.innerHTML = "";

          if (available > 0 && leftToday > 0) {
            const btn = document.createElement("button");
            btn.className = "claim-btn";
            btn.setAttribute("aria-label", "Claim");
            btn.addEventListener("click", onClaimClick);
            claimAction.appendChild(btn);
          } else if (available <= 0) {
            const p = document.createElement("p");
            p.className = "no-claims-text";
            p.textContent =
              "Nothing to claim yet. Go vote, Brotato.";
            claimAction.appendChild(p);
          } else {
            const p = document.createElement("p");
            p.className = "no-claims-text";
            p.textContent =
              "You’ve used all claims for now. Come back later.";
            claimAction.appendChild(p);
          }
        }

        // ---------- On-chain Fetch ----------

        async function refreshAll() {
          if (!signer || !votingContract || !claimContract) return;

          const addr = currentAddress;
          if (!addr) return;

          // Parallel fetch for speed
          const [
            totalVotesGlobalBN,
            userTotalVotesBN,
            votesLeftTodayBN,
            maxVotesPerDayBN,
            claimInfo,
            maxClaimsPerDayBN
          ] = await Promise.all([
            votingContract.totalVotesGlobal(),
            votingContract.totalVotesOf(addr),
            votingContract.votesLeftToday(addr),
            votingContract.maxVotesPerDay(),
            claimContract.getUserClaimInfo(addr),
            claimContract.maxClaimsPerDay()
          ]);

          const totalVotesGlobal = totalVotesGlobalBN.toNumber();
          const userTotalVotes = userTotalVotesBN.toNumber();
          const votesLeftToday = votesLeftTodayBN.toNumber();
          const maxVotesPerDay = maxVotesPerDayBN.toNumber();

          const maxClaimsPerDay = maxClaimsPerDayBN.toNumber();

          // claimInfo = (dayIndex, claimsToday, votesClaimed, totalVotes, votesAvailable, claimsLeftToday)
          const claimsToday = claimInfo[1].toNumber();
          const votesAvailable = claimInfo[4].toNumber();
          const claimsLeftToday = claimInfo[5].toNumber();

          // Update thermometer
          updateThermometer(totalVotesGlobal);

          // Update voting UI
          updateVotingUI({
            totalVotesGlobal,
            userTotalVotes,
            votesLeftToday,
            maxVotesPerDay
          });

          // Update claim UI
          updateClaimUI({
            votesAvailable,
            claimsToday,
            claimsLeftToday,
            maxClaimsPerDay
          });

          // Leaderboard + rank
          const list = upsertLeaderboardEntry(
            addr,
            userTotalVotes
          );
          renderLeaderboard(addr);
          updateRankText(addr);

          // Show bottom leaderboard if we have any data
          if (list && list.length > 0) {
            leaderboardEl.classList.remove("hidden");
          }
        }

        // ---------- Click Handlers ----------

        async function onVoteClick() {
          if (!votingContract || !signer) return;
          try {
            const tx = await votingContract.vote({ value: 0 });
            await tx.wait();
            await refreshAll();
          } catch (err) {
            console.error("Vote tx failed", err);
            alert("Vote failed. Check console for details.");
          }
        }

        async function onClaimClick() {
          if (!claimContract || !signer) return;
          try {
            const tx = await claimContract.claim();
            await tx.wait();
            await refreshAll();
          } catch (err) {
            console.error("Claim tx failed", err);
            alert("Claim failed. Check console for details.");
          }
        }

        // ---------- Connect + Init ----------

        async function connectAndInit() {
          try {
            if (typeof window.ethereum === "undefined") {
              alert("No wallet found. Please install MetaMask.");
              return;
            }

            const eth = window.ethereum;

            // Ensure Linea Sepolia
            let chainIdHex = await eth.request({
              method: "eth_chainId"
            });
            if (chainIdHex !== LINEA_SEPOLIA_CHAIN_ID_HEX) {
              try {
                await eth.request({
                  method: "wallet_switchEthereumChain",
                  params: [{ chainId: LINEA_SEPOLIA_CHAIN_ID_HEX }]
                });
                chainIdHex = LINEA_SEPOLIA_CHAIN_ID_HEX;
              } catch (switchErr) {
                console.error(
                  "Could not switch to Linea Sepolia",
                  switchErr
                );
                alert(
                  "Please switch your wallet to Linea Sepolia (chainId 59141)."
                );
                return;
              }
            }

            provider = new ethers.providers.Web3Provider(eth);
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            currentAddress = await signer.getAddress();

            votingContract = new ethers.Contract(
              VOTING_ADDRESS,
              VOTING_ABI,
              signer
            );

            claimContract = new ethers.Contract(
              CLAIM_ADDRESS,
              CLAIM_ABI,
              signer
            );

            // Show main UI
            connectSection.classList.add("hidden");
            notVerifiedSection.classList.add("hidden");
            topLayout.classList.remove("hidden");
            leaderboardEl.classList.remove("hidden");

            await refreshAll();

            // Optional PoH check stub – always true for now
            // In future, wire to Linea Sumsub PoH API and show notVerifiedSection if false.
          } catch (err) {
            console.error("Connect/init error:", err);
            alert(
              "Could not connect wallet. Check console for details."
            );
          }
        }

        connectWalletButton.addEventListener("click", connectAndInit);
      })();
    </script>
  </body>
</html>
