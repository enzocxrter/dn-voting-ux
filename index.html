<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Dn Brotato Taterz Farm</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Dn Brotato Taterz Farm" />

    <link rel="icon" href="fabicon.png" />

    <style>
      @font-face {
        font-family: "OverstreetBibleBold";
        src: url("assets/fonts/overstreetbiblebold.ttf") format("truetype");
        font-weight: normal;
        font-style: normal;
        font-display: swap;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "OverstreetBibleBold", system-ui, -apple-system,
          BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: #ffffff;
        background: url("assets/images/background2.png") center center / cover
          no-repeat fixed;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .page {
        width: 100%;
        max-width: 1200px;
        padding: 20px 16px 60px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      /* HEADER / LOGO BAR */
      .header {
        width: 100%;
        height: 100px;
        background: transparent;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0;
      }

      .header-link {
        display: inline-block;
      }

      .header-logo {
        height: 80px;
        width: auto;
        transition: transform 0.3s ease;
      }

      .header-logo:hover {
        transform: scale(1.05);
      }

      /* TITLE */
      h1 {
        margin: 60px 0 40px;
        text-align: center;
        font-size: clamp(2.5rem, 5vw, 4.5rem);
        line-height: 1.1;
        text-transform: uppercase;
        text-shadow: 0 3px 6px rgba(0, 0, 0, 0.4);
        color: #000000; /* black title */
      }

      /* CONNECT SECTION */
      .connect-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
      }

      .connect-btn {
        border: none;
        padding: 0;
        background: transparent;
        cursor: pointer;
        display: block;
        width: 260px;
        height: 80px;
        background-image: url("assets/images/connect.png");
        background-position: center;
        background-repeat: no-repeat;
        background-size: contain;
        transition:
          transform 0.15s ease-out,
          background-image 0.15s ease-out;
      }

      .connect-btn:hover {
        background-image: url("assets/images/connecthover.png");
        transform: scale(1.15);
      }

      .connect-btn:active {
        transform: scale(0.98);
      }

      /* Hover text under connect */
      .connect-hover-text {
        margin-top: 16px;
        width: 100%;
        max-width: 600px;
        text-align: center;
        color: #f5f5f5;
        font-size: 2rem;
        opacity: 0;
        transform: translateY(8px);
        transition:
          opacity 0.2s ease-out,
          transform 0.2s ease-out;
        pointer-events: none;
      }

      .connect-wrapper:hover .connect-hover-text {
        opacity: 1;
        transform: translateY(0);
      }

      /* VOTING STATION */
      .voting-station {
        margin-top: 20px;
        width: 100%;
        max-width: 600px;
        text-align: center;
        color: #ffffff;
      }

      /* Layout: thermometer on left, stats on right (vote) */
      .voting-layout {
        display: flex;
        gap: 16px;
        align-items: flex-start;
        justify-content: center;
      }

      .voting-content {
        flex: 1;
        min-width: 0;
      }

      .voting-title {
        font-size: clamp(2rem, 4vw, 3rem);
        text-transform: uppercase;
        margin-bottom: 16px;
        text-shadow: 0 3px 6px rgba(0, 0, 0, 0.5);
      }

      /* PoH status line + rank */
      .poh-status {
        margin-bottom: 20px;
        font-size: 1.6rem;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        justify-content: center;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
      }

      .poh-status-label {
        color: #ffffff;
      }

      .poh-status-yes {
        color: #00ffe8;
        text-shadow:
          0 0 3px #000,
          0 0 6px #000,
          0 0 10px #000;
      }

      .poh-rank {
        font-size: 1.6rem;
        padding: 4px 12px;
        border-radius: 999px;
        background: rgba(18, 206, 236, 0.2);
        border: 1px solid rgba(0, 255, 232, 0.7);
        color: #00ffe8;
        text-shadow:
          0 0 3px #000,
          0 0 8px #000,
          0 0 12px #000;
      }

      .vote-stats {
        display: flex;
        flex-direction: column;
        gap: 12px;
        font-size: 1.4rem;
        margin-bottom: 24px;
      }

      .vote-stat-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(0, 0, 0, 0.45);
        padding: 10px 16px;
        border-radius: 10px;
      }

      .vote-stat-label {
        text-align: left;
      }

      .vote-stat-value {
        text-align: right;
      }

      .vote-action {
        margin-top: 10px;
        font-size: 1.6rem;
      }

      /* Image-based VOTE button */
      .vote-btn {
        border: none;
        padding: 0;
        background: transparent;
        cursor: pointer;
        display: inline-block;
        width: 220px;
        height: 70px;
        background-image: url("assets/images/vote.png");
        background-position: center;
        background-repeat: no-repeat;
        background-size: contain;
        transition:
          transform 0.15s ease-out,
          background-image 0.15s ease-out;
      }

      .vote-btn:hover {
        background-image: url("assets/images/votehover.png");
        transform: scale(1.15);
      }

      .vote-btn:active {
        transform: scale(0.98);
      }

      .no-votes-text {
        font-size: 1.6rem;
        opacity: 0.9;
      }

      /* Not PoH verified panel (fallback UI, though gating is off-chain) */
      .not-verified {
        margin-top: 24px;
        text-align: center;
        font-size: 1.4rem;
      }

      .verify-button {
        margin-top: 12px;
        display: inline-block;
        padding: 10px 24px;
        border-radius: 999px;
        background: #000000;
        color: #ffffff;
        text-decoration: none;
        text-transform: uppercase;
        font-size: 1.2rem;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.6);
      }

      /* LEFT SIDE: VOTE THERMOMETER */
      .thermo-wrapper {
        width: 200px;
        padding: 16px 12px 20px;
        background: rgba(0, 0, 0, 0.6);
        border-radius: 20px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.7);
        text-align: center;
      }

      .thermo-title {
        font-size: 1.4rem;
        text-transform: uppercase;
        margin-bottom: 12px;
      }

      .thermo-body {
        position: relative;
        width: 90px;
        height: 460px;
        margin: 0 auto 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .thermo-column {
        position: relative;
        width: 36px;
        height: 340px;
        margin-top: 6px;
        border-radius: 999px;
        border: 4px solid rgba(255, 255, 255, 0.9);
        overflow: hidden;
        background: linear-gradient(
          to top,
          rgba(255, 255, 255, 0.12),
          rgba(255, 255, 255, 0.25)
        );
      }

      .thermo-mercury {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 0%;
        background: linear-gradient(
          to top,
          #12ceec,
          #00ffe8
        );
        box-shadow: 0 0 12px rgba(0, 255, 232, 0.8);
        transition: height 0.6s ease-out;
      }

      .thermo-bulb {
        width: 56px;
        height: 56px;
        border-radius: 999px;
        border: 4px solid rgba(255, 255, 255, 0.95);
        background: radial-gradient(
          circle at 30% 30%,
          #00ffe8,
          #12ceec
        );
        box-shadow: 0 0 18px rgba(0, 255, 232, 0.7);
        margin-top: -6px;
      }

      .thermo-face {
        position: absolute;
        left: 50%;
        width: 78px;
        height: 78px;
        border-radius: 50%;
        transform: translateX(-50%);
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        border: none;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.9);
        bottom: 20px;
        transition: bottom 0.6s ease-out;
        z-index: 2;
      }

      .thermo-face img {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        object-fit: contain;
      }

      .thermo-face-goal {
        position: absolute;
        left: 50%;
        width: 78px;
        height: 78px;
        border-radius: 50%;
        transform: translateX(-50%);
        top: -6px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        border: none;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.9);
        z-index: 2;
      }

      .thermo-face-goal img {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        object-fit: contain;
      }

      .thermo-labels {
        font-size: 1.05rem;
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      #thermoCount {
        font-size: 1.3rem;
      }

      #thermoPercent {
        font-size: 1rem;
        opacity: 0.9;
      }

      .thermo-target {
        font-size: 0.9rem;
        opacity: 0.7;
      }

      /* LEADERBOARD */
      .leaderboard {
        margin-top: 40px;
        width: 100%;
        max-width: 600px;
        background: rgba(0, 0, 0, 0.6);
        border-radius: 16px;
        padding: 16px 20px 24px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.8);
      }

      .leaderboard-title {
        font-size: 1.8rem;
        text-transform: uppercase;
        margin-bottom: 12px;
        text-align: center;
      }

      .leaderboard-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 1.2rem;
      }

      .leaderboard-table th,
      .leaderboard-table td {
        padding: 8px 10px;
        text-align: left;
      }

      .leaderboard-table th {
        border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        opacity: 0.9;
      }

      .leaderboard-table tr:nth-child(even) td {
        background: rgba(255, 255, 255, 0.03);
      }

      .leaderboard-table td.rank-col {
        width: 40px;
      }

      .leaderboard-table td.title-col {
        width: 220px;
      }

      .leaderboard-table td.votes-col {
        text-align: right;
        width: 120px;
      }

      .leaderboard-row-me td {
        background: rgba(18, 206, 236, 0.18) !important;
        font-weight: 600;
      }

      @media (max-width: 600px) {
        .header {
          height: 80px;
        }

        .header-logo {
          height: 60px;
        }

        .connect-btn {
          width: 220px;
          height: 70px;
        }

        h1 {
          margin-top: 40px;
        }

        .connect-hover-text {
          font-size: 1.6rem;
        }

        .vote-stats {
          font-size: 1.2rem;
        }

        .vote-btn,
        .no-votes-text {
          font-size: 1.4rem;
        }

        .poh-status {
          font-size: 1.4rem;
        }

        .voting-layout {
          flex-direction: column;
          align-items: center;
        }

        .thermo-wrapper {
          width: 220px;
        }
      }

      .hidden {
        display: none !important;
      }
    </style>
  </head>

  <body>
    <div class="page">
      <header class="header">
        <a
          href="https://www.davydonothing.com"
          target="_blank"
          rel="noopener noreferrer"
          class="header-link"
        >
          <img
            src="assets/images/dnlogo2.png"
            alt="DN Brotato logo"
            class="header-logo"
          />
        </a>
      </header>

      <h1>DN Voting Platform</h1>

      <!-- STATE 1: CONNECT (shown initially) -->
      <div class="connect-wrapper" id="connectSection">
        <button
          class="connect-btn"
          id="connectWalletButton"
          aria-label="Connect Wallet"
        ></button>

        <div class="connect-hover-text" id="connectHoverText">
          <p>Connect your wallet to vote on SERIOUS topics</p>
        </div>
      </div>

      <!-- STATE 2: NOT POH VERIFIED (fallback) -->
      <div class="not-verified hidden" id="notVerifiedSection">
        <p>This wallet is not PoH verified yet.</p>
        <a
          href="https://linea.build/hub/apps/sumsub-reusable-identity"
          target="_blank"
          rel="noopener noreferrer"
          class="verify-button"
          id="verifyLink"
        >
          Verify Here
        </a>
      </div>

      <!-- STATE 3: VOTING STATION -->
      <div class="voting-station hidden" id="votingSection">
        <div class="voting-layout">
          <!-- LEFT: Vote Thermometer -->
          <div class="thermo-wrapper">
            <div class="thermo-title">Vote Heat</div>

            <div class="thermo-body">
              <div class="thermo-column">
                <div class="thermo-mercury" id="thermoMercury"></div>
              </div>
              <div class="thermo-bulb"></div>

              <div class="thermo-face-goal">
                <img src="assets/images/DevlanBald.png" alt="Devlan bald" />
              </div>

              <div class="thermo-face" id="thermoFace">
                <img src="assets/images/Devlan.png" alt="Devlan face" />
              </div>
            </div>

            <div class="thermo-labels">
              <div id="thermoCount">0</div>
              <div id="thermoPercent">0% to target</div>
              <div class="thermo-target" id="thermoTarget">
                Target: 5,000 votes
              </div>
            </div>
          </div>

          <!-- RIGHT: Vote content -->
          <div class="voting-content">
            <div class="voting-title">Voting station</div>

            <div class="poh-status">
              <span class="poh-status-label">Proof of Humanity verified: </span>
              <span class="poh-status-yes" id="pohYesText">Yes</span>
              <span class="poh-rank hidden" id="userRankLabel"></span>
            </div>

            <!-- VOTE STATS -->
            <div class="vote-stats">
              <div class="vote-stat-row">
                <div class="vote-stat-label">Total votes (global)</div>
                <div class="vote-stat-value" id="totalVotes">0</div>
              </div>

              <div class="vote-stat-row">
                <div class="vote-stat-label">Your total votes</div>
                <div class="vote-stat-value" id="userTotalVotes">0</div>
              </div>

              <div class="vote-stat-row">
                <div class="vote-stat-label">Votes today</div>
                <div class="vote-stat-value" id="votesToday">0/10</div>
              </div>
            </div>

            <div class="vote-action" id="voteAction"></div>
          </div>
        </div>
      </div>

      <!-- LEADERBOARD -->
      <div class="leaderboard" id="leaderboardSection">
        <div class="leaderboard-title">Top Voters</div>
        <table class="leaderboard-table">
          <thead>
            <tr>
              <th class="rank-col">#</th>
              <th class="title-col">Title</th>
              <th>Wallet</th>
              <th class="votes-col">Total Votes</th>
            </tr>
          </thead>
          <tbody id="leaderboardBody">
            <tr>
              <td colspan="4">No votes yet. Be the first to vote.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ethers.js v6 -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>

    <script>
      // ----- DOM ELEMENTS -----
      const connectSection = document.getElementById("connectSection");
      const notVerifiedSection = document.getElementById("notVerifiedSection");
      const votingSection = document.getElementById("votingSection");
      const voteAction = document.getElementById("voteAction");
      const leaderboardBody = document.getElementById("leaderboardBody");
      const connectHoverText = document.getElementById("connectHoverText");

      const totalVotesEl = document.getElementById("totalVotes");
      const userTotalVotesEl = document.getElementById("userTotalVotes");
      const votesTodayEl = document.getElementById("votesToday");

      const thermoMercury = document.getElementById("thermoMercury");
      const thermoFace = document.getElementById("thermoFace");
      const thermoCount = document.getElementById("thermoCount");
      const thermoPercent = document.getElementById("thermoPercent");
      const thermoTarget = document.getElementById("thermoTarget");

      const connectWalletButton =
        document.getElementById("connectWalletButton");

      const userRankLabel = document.getElementById("userRankLabel");

      // ----- CONSTANTS -----
      const LINEA_MAINNET_CHAIN_ID = 59144n;
      const CONTRACT_ADDRESS = "0xBE817fd849FbF8DBd07840F2F3a89F2D649994A3";

      const DEFAULT_MAX_PER_DAY = 10;
      const DEFAULT_TARGET_VOTES = 5000;

      // mutable UI target votes, possibly overridden by contract.targetVotes()
      let targetVotesUi = DEFAULT_TARGET_VOTES;

      // ABI for the combined Vote+Claim contract (each claim = 1 vote)
      const VOTE_ABI = [
        "function maxClaimsPerDay() view returns (uint8)",
        "function targetVotes() view returns (uint256)",
        "function totalVotesGlobal() view returns (uint256)",
        "function totalVotesOf(address user) view returns (uint256)",
        "function getUserClaimInfo(address user) view returns (uint64 dayIndex, uint8 claimsToday, uint256 votesClaimed, uint256 totalVotes, uint256 votesAvailable, uint8 claimsLeftToday)",
        "function claim()",
        "event Voted(address indexed voter, uint64 indexed dayIndex, uint8 votesToday, uint256 totalVotes, uint256 totalVotesGlobal)"
      ];

      // ----- RANK TITLES -----
      function getRankTitle(rank) {
        switch (rank) {
          case 1:
            return "Follicle Liquidatooor";
          case 2:
            return "Hairline Rugpuller";
          case 3:
            return "The Buzzcut Butcher";
          case 4:
            return "Scalp Sniper";
          case 5:
            return "Chrome Dome Degen";
          case 6:
            return "The Clippersmith";
          case 7:
            return "The Bald Bringer";
          case 8:
            return "Harbinger of Hair Loss";
          case 9:
            return "The Hairline Eradicator";
          case 10:
            return "Supreme Scalp Sacrificer";
          case 11:
            return "The No-Hair Enabler";
          case 12:
            return "Clipper Kingpin";
          case 13:
            return "Follicle Doom Dealer";
          case 14:
            return "Clean Cut Kingmaker";
          case 15:
            return "Final Strand Supervisor";
          case 16:
            return "Commander of Clippers";
          case 17:
            return "Buzzcut Broker";
          case 18:
            return "Final Shave Boss";
          case 19:
            return "DN Bladesmith";
          case 20:
            return "Clean Shave Sgt";
          default:
            return "Bald Enforcer";
        }
      }

      // ----- STATE -----
      let provider;
      let signer;
      let signerAddress;
      let voteContract;
      let userRank = null;

      function shortenAddress(addr) {
        if (!addr) return "";
        return addr.slice(0, 6) + "..." + addr.slice(-4);
      }

      // ----- PoH HTTP GATING -----
      // Uses Linea PoH HTTP API to check if address is a verified human.
      // NOTE: Endpoint/JSON shape may need tweaking based on the latest docs.
      async function checkPohOffchain(address) {
        try {
          // Example endpoint from Linea docs. Adjust if needed.
          const url = `https://poh.linea.build/api/registry/${address}`;
          const res = await fetch(url, {
            method: "GET"
          });

          if (!res.ok) {
            console.warn("PoH API non-200:", res.status);
            return false;
          }

          const data = await res.json();
          // You may need to adapt these fields based on actual response
          const isHuman =
            data?.status === "approved" ||
            data?.isHuman === true ||
            data?.verified === true;

          console.log("PoH API result:", isHuman);
          return !!isHuman;
        } catch (err) {
          console.error("PoH API error:", err);
          return false;
        }
      }

      function updateRankLabel() {
        if (!userRankLabel) return;

        if (userRank && userRank > 0) {
          const title = getRankTitle(userRank);
          userRankLabel.textContent = `Your rank = #${userRank} - ${title}`;
          userRankLabel.classList.remove("hidden");
        } else {
          userRankLabel.textContent = "";
          userRankLabel.classList.add("hidden");
        }
      }

      async function ensureProvider() {
        if (!window.ethereum) {
          alert(
            "No injected wallet found. Please install MetaMask or a compatible wallet."
          );
          throw new Error("No wallet");
        }

        if (!provider) {
          provider = new window.ethers.BrowserProvider(window.ethereum);
        }
        return provider;
      }

      async function refreshUserAndGlobalState() {
        if (!voteContract || !signerAddress) return;

        // Default assumptions
        let maxPerDay = DEFAULT_MAX_PER_DAY;
        let totalVotesGlobal = 0;
        let userTotalVotes = 0;
        let votesTodayUsed = 0;

        // 1) Attempt to read targetVotes from contract
        try {
          const tv = await voteContract.targetVotes();
          targetVotesUi = Number(tv);
        } catch (err) {
          console.warn(
            "targetVotes() not available or reverted, using default:",
            err
          );
          targetVotesUi = DEFAULT_TARGET_VOTES;
        }

        // 2) Attempt to read user info + global total
        let info = null;
        try {
          [info, totalVotesGlobal] = await Promise.all([
            voteContract.getUserClaimInfo(signerAddress),
            voteContract.totalVotesGlobal()
          ]);
        } catch (err) {
          console.error("Error reading user/global state:", err);
        }

        // 3) Try to read maxClaimsPerDay (may be owner-only or revert)
        try {
          const mp = await voteContract.maxClaimsPerDay();
          maxPerDay = Number(mp);
        } catch (err) {
          console.warn(
            "maxClaimsPerDay() reverted; using default 10 in UI:",
            err
          );
          maxPerDay = DEFAULT_MAX_PER_DAY;
        }

        // Parse user info if we got it
        if (info) {
          // info = (dayIndex, claimsToday, votesClaimed, totalVotes, votesAvailable, claimsLeftToday)
          const claimsLeftToday = Number(info[5]);
          userTotalVotes = Number(info[3]);
          votesTodayUsed =
            maxPerDay > claimsLeftToday ? maxPerDay - claimsLeftToday : 0;
        }

        showVotingStation({
          totalVotesGlobal: Number(totalVotesGlobal),
          userTotalVotes,
          votesTodayUsed,
          maxVotesPerDay: maxPerDay
        });
      }

      async function connectAndInit() {
        await ensureProvider();

        const network = await provider.getNetwork();
        if (network.chainId !== LINEA_MAINNET_CHAIN_ID) {
          alert("Please switch your wallet to Linea mainnet.");
          throw new Error("Wrong chain");
        }

        signer = await provider.getSigner();
        signerAddress = await signer.getAddress();

        voteContract = new window.ethers.Contract(
          CONTRACT_ADDRESS,
          VOTE_ABI,
          signer
        );

        await refreshUserAndGlobalState();
        await loadLeaderboard();
      }

      connectWalletButton.addEventListener("click", async () => {
        if (!window.ethereum) {
          alert(
            "No injected wallet found. Please install MetaMask or a compatible wallet."
          );
          return;
        }

        try {
          connectWalletButton.disabled = true;

          // Request account from wallet
          const accounts = await window.ethereum.request({
            method: "eth_requestAccounts"
          });
          if (!accounts || !accounts.length) {
            alert("No wallet account found.");
            return;
          }

          const addr = accounts[0];

          // Off-chain PoH check BEFORE showing the main UX
          const isHuman = await checkPohOffchain(addr);
          if (!isHuman) {
            // Show PoH fail UI and link
            connectHoverText.innerHTML =
              "<p>This wallet is not PoH verified yet. Click below to verify.</p>";
            connectSection.classList.remove("hidden");
            notVerifiedSection.classList.remove("hidden");
            votingSection.classList.add("hidden");
            alert(
              "This wallet is not PoH-verified. You will be redirected to complete verification."
            );
            window.open(
              "https://linea.build/hub/apps/sumsub-reusable-identity",
              "_blank"
            );
            return;
          }

          // Save signer address and proceed to contract-based init
          signerAddress = addr;
          await connectAndInit();
        } catch (err) {
          console.error("Connect/init error:", err);
          alert("Could not connect wallet. Check console for details.");
        } finally {
          connectWalletButton.disabled = false;
        }
      });

      function showVotingStation({
        totalVotesGlobal,
        userTotalVotes,
        votesTodayUsed,
        maxVotesPerDay
      }) {
        connectSection.classList.add("hidden");
        notVerifiedSection.classList.add("hidden");
        votingSection.classList.remove("hidden");

        totalVotesEl.textContent = totalVotesGlobal.toLocaleString();
        userTotalVotesEl.textContent = userTotalVotes.toLocaleString();
        votesTodayEl.textContent = `${Math.max(
          maxVotesPerDay - votesTodayUsed,
          0
        )}/${maxVotesPerDay}`;

        const pctRaw =
          targetVotesUi > 0
            ? (totalVotesGlobal / targetVotesUi) * 100
            : 0;
        const pct = Math.max(0, Math.min(pctRaw, 100));

        const MERCURY_OFFSET = 7;
        const mercuryPct = Math.max(0, Math.min(pct - MERCURY_OFFSET, 100));

        if (thermoMercury) {
          thermoMercury.style.height = mercuryPct + "%";
        }
        if (thermoCount) {
          thermoCount.textContent = totalVotesGlobal.toLocaleString();
        }
        if (thermoPercent) {
          thermoPercent.textContent = `${pct.toFixed(1)}% to target`;
        }
        if (thermoTarget) {
          thermoTarget.textContent = `Target: ${targetVotesUi.toLocaleString()} votes`;
        }

        if (thermoFace) {
          const MIN_BOTTOM = 20;
          const MAX_BOTTOM = 340;

          const t = pct / 100;
          const eased = Math.pow(t, 0.6);

          const faceBottom =
            MIN_BOTTOM + (MAX_BOTTOM - MIN_BOTTOM) * eased;

          thermoFace.style.bottom = `${faceBottom}px`;
        }

        voteAction.innerHTML = "";

        if (votesTodayUsed < maxVotesPerDay) {
          const btn = document.createElement("button");
          btn.className = "vote-btn";
          btn.setAttribute("aria-label", "Vote");
          btn.addEventListener("click", onVoteClick);
          voteAction.appendChild(btn);
        } else {
          const p = document.createElement("p");
          p.className = "no-votes-text";
          p.textContent = "Youâ€™ve used all votes for now. Come back later.";
          voteAction.appendChild(p);
        }
      }

      async function onVoteClick() {
        if (!voteContract || !signerAddress) return;

        try {
          const tx = await voteContract.claim(); // claim = vote+TATERZ
          await tx.wait();

          await refreshUserAndGlobalState();
          await loadLeaderboard();
        } catch (err) {
          console.error("Claim/vote tx error:", err);
          alert("Claim/vote transaction failed or was rejected.");
        }
      }

      async function loadLeaderboard() {
        if (!voteContract || !provider || !leaderboardBody) return;

        leaderboardBody.innerHTML = "";

        let entries = [];

        try {
          const currentBlock = await provider.getBlockNumber();
          const fromBlock =
            currentBlock > 200_000 ? currentBlock - 200_000 : 0;

          if (!voteContract.filters || !voteContract.filters.Voted) {
            throw new Error("Voted event not available in ABI/contract");
          }

          const filter = voteContract.filters.Voted();
          const events = await voteContract.queryFilter(
            filter,
            fromBlock,
            currentBlock
          );

          const map = new Map();

          for (const ev of events) {
            const voter = ev.args.voter.toLowerCase();
            const userTotalVotes = Number(ev.args.totalVotes);
            const prev = map.get(voter);
            if (!prev || userTotalVotes > prev) {
              map.set(voter, userTotalVotes);
            }
          }

          entries = Array.from(map.entries()).map(([address, totalVotes]) => ({
            address,
            totalVotes
          }));
        } catch (err) {
          console.warn("Leaderboard event fetch failed:", err);
        }

        // Ensure connected wallet appears even if no recent event
        if (signerAddress && voteContract.totalVotesOf) {
          try {
            const directTotalBN = await voteContract.totalVotesOf(
              signerAddress
            );
            const directTotal = Number(directTotalBN);
            const lower = signerAddress.toLowerCase();
            const existing = entries.find((e) => e.address === lower);

            if (directTotal > 0) {
              if (existing) {
                existing.totalVotes = Math.max(
                  existing.totalVotes,
                  directTotal
                );
              } else {
                entries.push({ address: lower, totalVotes: directTotal });
              }
            }
          } catch (err) {
            console.error(
              "Direct totalVotesOf for leaderboard failed:",
              err
            );
          }
        }

        entries.sort((a, b) => b.totalVotes - a.totalVotes);
        entries = entries.slice(0, 20); // top 20

        if (!entries.length) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 4;
          td.textContent = "No votes yet. Be the first to vote.";
          tr.appendChild(td);
          leaderboardBody.appendChild(tr);
          userRank = null;
          updateRankLabel();
          return;
        }

        let userRankLocal = null;

        entries.forEach((entry, index) => {
          const rank = index + 1;
          const tr = document.createElement("tr");

          if (signerAddress && entry.address === signerAddress.toLowerCase()) {
            tr.classList.add("leaderboard-row-me");
            userRankLocal = rank;
          }

          const rankTd = document.createElement("td");
          rankTd.className = "rank-col";
          rankTd.textContent = rank.toString();

          const titleTd = document.createElement("td");
          titleTd.className = "title-col";
          titleTd.textContent = getRankTitle(rank);

          const addrTd = document.createElement("td");
          addrTd.textContent = shortenAddress(entry.address);

          const votesTd = document.createElement("td");
          votesTd.className = "votes-col";
          votesTd.textContent = entry.totalVotes.toLocaleString();

          tr.append(rankTd, titleTd, addrTd, votesTd);
          leaderboardBody.appendChild(tr);
        });

        userRank = userRankLocal;
        updateRankLabel();
      }
    </script>
  </body>
</html>
