<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Dn Brotato Taterz Farm</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Dn Brotato Taterz Farm" />

    <!-- Use dnlogo as favicon so we don't 404 -->
    <link rel="icon" href="assets/images/dnlogo2.png" />

    <style>
      @font-face {
        font-family: "OverstreetBibleBold";
        src: url("assets/fonts/overstreetbiblebold.ttf") format("truetype");
        font-weight: normal;
        font-style: normal;
        font-display: swap;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "OverstreetBibleBold", system-ui, -apple-system,
          BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: #ffffff;
        background: url("assets/images/background2.png") center center / cover
          no-repeat fixed;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .page {
        width: 100%;
        max-width: 1200px;
        padding: 20px 16px 60px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      /* HEADER / LOGO BAR */
      .header {
        width: 100%;
        height: 100px;
        background: transparent;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0;
      }

      .header-link {
        display: inline-block;
      }

      .header-logo {
        height: 80px;
        width: auto;
        transition: transform 0.3s ease;
      }

      .header-logo:hover {
        transform: scale(1.05);
      }

      /* TITLE */
      h1 {
        margin: 60px 0 40px;
        text-align: center;
        font-size: clamp(2.5rem, 5vw, 4.5rem);
        line-height: 1.1;
        text-transform: uppercase;
        text-shadow: 0 3px 6px rgba(0, 0, 0, 0.4);
        color: #000000; /* black title */
      }

      /* CONNECT SECTION */
      .connect-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
      }

      .connect-btn {
        border: none;
        padding: 0;
        background: transparent;
        cursor: pointer;
        display: block;
        width: 260px;
        height: 80px;
        background-image: url("assets/images/connect.png");
        background-position: center;
        background-repeat: no-repeat;
        background-size: contain;
        transition:
          transform 0.15s ease-out,
          background-image 0.15s ease-out;
        transform: scale(1); /* helps avoid first-hover glitch */
        will-change: transform;
      }

      .connect-btn:hover {
        background-image: url("assets/images/connecthover.png");
        transform: scale(1.15);
      }

      .connect-btn:active {
        transform: scale(0.98);
      }

      /* Hover text under connect */
      .connect-hover-text {
        margin-top: 16px;
        width: 100%;
        max-width: 600px;
        text-align: center;
        color: #f5f5f5;
        font-size: 2rem;
        opacity: 0;
        transform: translateY(8px);
        transition:
          opacity 0.2s ease-out,
          transform 0.2s ease-out;
        pointer-events: none;
      }

      .connect-wrapper:hover .connect-hover-text {
        opacity: 1;
        transform: translateY(0);
      }

      /* VOTING STATION */
      .voting-station {
        margin-top: 20px;
        width: 100%;
        max-width: 540px; /* narrower center box */
        text-align: center;
        color: #ffffff;
      }

      /* Layout: thermometer on left, stats on right */
      .voting-layout {
        display: flex;
        gap: 24px;
        align-items: flex-start;
        justify-content: center;
      }

      .voting-content {
        flex: 1;
        min-width: 0;
      }

      .voting-title {
        font-size: clamp(2rem, 4vw, 3rem);
        text-transform: uppercase;
        margin-bottom: 16px;
        text-shadow: 0 3px 6px rgba(0, 0, 0, 0.5);
      }

      /* PoH status line */
      .poh-status {
        margin-bottom: 20px;
        font-size: 1.4rem;
      }

      .poh-status-label {
        color: #ffffff;
      }

      .poh-status-yes {
        color: #1f7a3a;
      }

      .vote-stats {
        display: flex;
        flex-direction: column;
        gap: 12px;
        font-size: 1.4rem;
        margin-bottom: 30px;
      }

      .vote-stat-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(0, 0, 0, 0.45);
        padding: 10px 16px;
        border-radius: 10px;
      }

      .vote-stat-label {
        text-align: left;
      }

      .vote-stat-value {
        text-align: right;
      }

      /* Vote action area */
      .vote-action {
        margin-top: 10px;
        font-size: 1.6rem;
      }

      /* Image-based VOTE button */
      .vote-btn {
        border: none;
        padding: 0;
        background: transparent;
        cursor: pointer;
        display: inline-block;
        width: 220px;
        height: 70px;
        background-image: url("assets/images/vote.png");
        background-position: center;
        background-repeat: no-repeat;
        background-size: contain;
        transition:
          transform 0.15s ease-out,
          background-image 0.15s ease-out;
        transform: scale(1); /* helps avoid first-hover glitch */
        will-change: transform;
      }

      .vote-btn:hover {
        background-image: url("assets/images/votehover.png");
        transform: scale(1.15);
      }

      .vote-btn:active {
        transform: scale(0.98);
      }

      .no-votes-text {
        font-size: 1.6rem;
        opacity: 0.9;
      }

      /* Shared loading state for buttons */
      .connect-btn.loading,
      .vote-btn.loading {
        opacity: 0.6;
        pointer-events: none;
        transform: scale(0.95) !important;
      }

      /* Not PoH verified panel */
      .not-verified {
        margin-top: 24px;
        text-align: center;
        font-size: 1.4rem;
      }

      .verify-button {
        margin-top: 12px;
        display: inline-block;
        padding: 10px 24px;
        border-radius: 999px;
        background: #000000;
        color: #ffffff;
        text-decoration: none;
        text-transform: uppercase;
        font-size: 1.2rem;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.6);
      }

      /* LEFT SIDE: VOTE THERMOMETER */
      .thermo-wrapper {
        width: 200px;
        padding: 16px 12px 20px;
        background: rgba(0, 0, 0, 0.6);
        border-radius: 20px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.7);
        text-align: center;
      }

      .thermo-title {
        font-size: 1.4rem;
        text-transform: uppercase;
        margin-bottom: 12px;
      }

      .thermo-body {
        position: relative;
        width: 90px;
        height: 460px; /* tall thermometer */
        margin: 0 auto 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .thermo-column {
        position: relative;
        width: 36px;
        height: 340px;
        margin-top: 6px;
        border-radius: 999px;
        border: 4px solid rgba(255, 255, 255, 0.9);
        overflow: hidden;
        background: linear-gradient(
          to top,
          rgba(255, 255, 255, 0.12),
          rgba(255, 255, 255, 0.25)
        );
      }

      .thermo-mercury {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 0%; /* JS updates this */
        background: linear-gradient(
          to top,
          #12ceec,
          #00ffe8
        );
        box-shadow: 0 0 12px rgba(0, 255, 232, 0.8);
        transition: height 0.6s ease-out;
      }

      .thermo-bulb {
        width: 56px;
        height: 56px;
        border-radius: 999px;
        border: 4px solid rgba(255, 255, 255, 0.95);
        background: radial-gradient(
          circle at 30% 30%,
          #00ffe8,
          #12ceec
        );
        box-shadow: 0 0 18px rgba(0, 255, 232, 0.7);
        margin-top: -6px;
      }

      /* Moving face riding the mercury (Devlan with hair) */
      .thermo-face {
        position: absolute;
        left: 50%;
        width: 78px;
        height: 78px;
        border-radius: 50%;
        transform: translateX(-50%);
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent; /* no black */
        border: none; /* no white ring */
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.9);
        bottom: 20px; /* JS will adjust based on percentage */
        transition: bottom 0.6s ease-out;
        z-index: 2;
      }

      .thermo-face img {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        object-fit: contain;
      }

      /* Goal face at the top (Devlan bald) */
      .thermo-face-goal {
        position: absolute;
        left: 50%;
        width: 78px;
        height: 78px;
        border-radius: 50%;
        transform: translateX(-50%);
        top: -6px; /* sits right at the top as the goal */
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        border: none; /* no white ring */
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.9);
        z-index: 2;
      }

      .thermo-face-goal img {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        object-fit: contain;
      }

      .thermo-labels {
        font-size: 1.05rem;
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      #thermoCount {
        font-size: 1.3rem;
      }

      #thermoPercent {
        font-size: 1rem;
        opacity: 0.9;
      }

      .thermo-target {
        font-size: 0.9rem;
        opacity: 0.7;
      }

      @media (max-width: 600px) {
        .header {
          height: 80px;
        }

        .header-logo {
          height: 60px;
        }

        .connect-btn {
          width: 220px;
          height: 70px;
        }

        h1 {
          margin-top: 40px;
        }

        .connect-hover-text {
          font-size: 1.6rem;
        }

        .vote-stats {
          font-size: 1.2rem;
        }

        .vote-btn,
        .no-votes-text {
          font-size: 1.4rem;
        }

        .poh-status {
          font-size: 1.2rem;
        }

        .voting-layout {
          flex-direction: column;
          align-items: center;
        }

        .thermo-wrapper {
          width: 220px;
        }
      }

      /* helper: hidden class */
      .hidden {
        display: none !important;
      }
    </style>
  </head>

  <body>
    <div class="page">
      <header class="header">
        <a
          href="https://www.davydonothing.com"
          target="_blank"
          rel="noopener noreferrer"
          class="header-link"
        >
          <img
            src="assets/images/dnlogo2.png"
            alt="DN Brotato logo"
            class="header-logo"
          />
        </a>
      </header>

      <h1>DN Voting Platform</h1>

      <!-- STATE 1: CONNECT (shown initially) -->
      <div class="connect-wrapper" id="connectSection">
        <button
          class="connect-btn"
          id="connectWalletButton"
          aria-label="Connect Wallet"
        ></button>

        <div class="connect-hover-text">
          <p>Connect your wallet to vote on SERIOUS topics</p>
        </div>
      </div>

      <!-- STATE 2: NOT PoH VERIFIED -->
      <div class="not-verified hidden" id="notVerifiedSection">
        <p>This wallet is not PoH verified yet.</p>
        <a
          href="#"
          target="_blank"
          rel="noopener noreferrer"
          class="verify-button"
          id="verifyLink"
        >
          Verify Here
        </a>
      </div>

      <!-- STATE 3: VOTING STATION -->
      <div class="voting-station hidden" id="votingSection">
        <div class="voting-layout">
          <!-- LEFT: Vote Thermometer -->
          <div class="thermo-wrapper">
            <div class="thermo-title">Vote Heat</div>

            <div class="thermo-body">
              <div class="thermo-column">
                <div class="thermo-mercury" id="thermoMercury"></div>
              </div>
              <div class="thermo-bulb"></div>

              <!-- Goal face (Devlan bald) at the top -->
              <div class="thermo-face-goal">
                <img src="assets/images/DevlanBald.png" alt="Devlan bald" />
              </div>

              <!-- Moving face (Devlan with hair) following the mercury -->
              <div class="thermo-face" id="thermoFace">
                <img src="assets/images/Devlan.png" alt="Devlan face" />
              </div>
            </div>

            <div class="thermo-labels">
              <div id="thermoCount">0</div>
              <div id="thermoPercent">0% to target</div>
              <div class="thermo-target" id="thermoTarget">
                Target: 5,000 votes
              </div>
            </div>
          </div>

          <!-- RIGHT: Existing content -->
          <div class="voting-content">
            <div class="voting-title">Voting station</div>

            <!-- PoH status line -->
            <div class="poh-status">
              <span class="poh-status-label">Proof of Humanity verified: </span>
              <span class="poh-status-yes">Yes</span>
            </div>

            <div class="vote-stats">
              <div class="vote-stat-row">
                <div class="vote-stat-label">Total votes</div>
                <div class="vote-stat-value" id="totalVotes">0</div>
              </div>

              <div class="vote-stat-row">
                <div class="vote-stat-label">Your total votes</div>
                <div class="vote-stat-value" id="userTotalVotes">0</div>
              </div>

              <div class="vote-stat-row">
                <div class="vote-stat-label">Votes today</div>
                <div class="vote-stat-value" id="votesToday">0/10</div>
              </div>
            </div>

            <div class="vote-action" id="voteAction">
              <!-- JS drops VOTE button or "Come back later" text here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ethers.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

    <script>
      console.log("DN Voting script loaded");

      const connectSection = document.getElementById("connectSection");
      const notVerifiedSection = document.getElementById("notVerifiedSection");
      const votingSection = document.getElementById("votingSection");
      const voteAction = document.getElementById("voteAction");

      const totalVotesEl = document.getElementById("totalVotes");
      const userTotalVotesEl = document.getElementById("userTotalVotes");
      const votesTodayEl = document.getElementById("votesToday");

      const connectWalletButton =
        document.getElementById("connectWalletButton");

      // Thermometer elements
      const thermoMercury = document.getElementById("thermoMercury");
      const thermoFace = document.getElementById("thermoFace");
      const thermoCount = document.getElementById("thermoCount");
      const thermoPercent = document.getElementById("thermoPercent");
      const thermoTarget = document.getElementById("thermoTarget");

      // ---- Chain / contract config ----
      const LINEA_SEPOLIA_DEC = 59141;
      const LINEA_SEPOLIA_HEX = "0xe705";

      const CONTRACT_ADDRESS =
        "0xF2e347e7E7D86Ec1CD90914514b4Ee7dC09cB2bD";

      const CONTRACT_ABI = [
        "function maxVotesPerDay() view returns (uint8)",
        "function voteFeeWei() view returns (uint256)",
        "function totalVotesGlobal() view returns (uint256)",
        "function votesLeftToday(address user) view returns (uint8)",
        "function getUserInfo(address user) view returns (uint64 dayIndex,uint8 votesToday,uint256 totalVotes,uint8 votesLeft)",
        "function vote() payable"
      ];

      let provider = null;
      let signer = null;
      let votingContract = null;
      let connectedAddress = null;
      let voteFeeWei = null;

      let MAX_VOTES_PER_DAY = 10;
      const DEFAULT_TARGET_VOTES = 5000;
      let TARGET_VOTES = DEFAULT_TARGET_VOTES;

      let voteButtonRef = null; // track current vote button for loading state

      console.log("connectWalletButton:", !!connectWalletButton);

      connectWalletButton.addEventListener("click", handleConnectClick);

      async function handleConnectClick() {
        try {
          console.log("Connect clicked");
          connectWalletButton.classList.add("loading");

          if (typeof window.ethereum === "undefined") {
            alert(
              "No Web3 wallet detected. Please install MetaMask or another wallet."
            );
            return;
          }

          if (typeof window.ethers === "undefined") {
            alert("Internal error: ethers.js failed to load.");
            return;
          }

          provider = new window.ethers.providers.Web3Provider(
            window.ethereum
          );
          await provider.send("eth_requestAccounts", []);

          let network = await provider.getNetwork();
          console.log("Current network chainId:", network.chainId);

          if (network.chainId !== LINEA_SEPOLIA_DEC) {
            try {
              await window.ethereum.request({
                method: "wallet_switchEthereumChain",
                params: [{ chainId: LINEA_SEPOLIA_HEX }]
              });
            } catch (switchError) {
              if (switchError.code === 4902) {
                try {
                  await window.ethereum.request({
                    method: "wallet_addEthereumChain",
                    params: [
                      {
                        chainId: LINEA_SEPOLIA_HEX,
                        chainName: "Linea Sepolia",
                        rpcUrls: ["https://rpc.sepolia.linea.build"],
                        nativeCurrency: {
                          name: "Ether",
                          symbol: "ETH",
                          decimals: 18
                        },
                        blockExplorerUrls: ["https://sepolia.lineascan.build/"]
                      }
                    ]
                  });
                } catch (addError) {
                  console.error(addError);
                  alert(
                    "Please add the Linea Sepolia network to your wallet and try again."
                  );
                  return;
                }
              } else {
                console.error(switchError);
                alert(
                  "Please switch your wallet to the Linea Sepolia network and try again."
                );
                return;
              }
            }

            provider = new window.ethers.providers.Web3Provider(
              window.ethereum
            );
            network = await provider.getNetwork();
            console.log("Network after switch:", network.chainId);
          }

          signer = provider.getSigner();
          connectedAddress = await signer.getAddress();
          console.log("Connected address:", connectedAddress);

          votingContract = new window.ethers.Contract(
            CONTRACT_ADDRESS,
            CONTRACT_ABI,
            signer
          );

          const [maxPerDayFromChain, fee, userInfo, totalGlobal] =
            await Promise.all([
              votingContract.maxVotesPerDay(),
              votingContract.voteFeeWei(),
              votingContract.getUserInfo(connectedAddress),
              votingContract.totalVotesGlobal()
            ]);

          console.log("getUserInfo raw:", userInfo);

          MAX_VOTES_PER_DAY = Number(maxPerDayFromChain);
          voteFeeWei = fee;

          const votesTodayUsed = Number(
            userInfo.votesToday !== undefined ? userInfo.votesToday : userInfo[1]
          );
          const userTotalVotes = Number(
            userInfo.totalVotes !== undefined ? userInfo.totalVotes : userInfo[2]
          );
          const votesLeft = Number(
            userInfo.votesLeft !== undefined ? userInfo.votesLeft : userInfo[3]
          );

          // PoH still stubbed for now
          const isVerified = await checkPohStub(connectedAddress);

          if (!isVerified) {
            showNotVerified();
            return;
          }

          showVotingStation(
            Number(totalGlobal),
            userTotalVotes,
            votesTodayUsed,
            votesLeft
          );
        } catch (err) {
          console.error("handleConnectClick error:", err);
          const msg =
            (err && err.message) ||
            "Error connecting wallet. Check the console for details.";
          alert(msg);
        } finally {
          connectWalletButton.classList.remove("loading");
        }
      }

      function showNotVerified() {
        connectSection.classList.add("hidden");
        votingSection.classList.add("hidden");
        notVerifiedSection.classList.remove("hidden");
      }

      function showVotingStation(
        totalVotes,
        userTotalVotes,
        votesTodayUsed,
        votesLeft
      ) {
        connectSection.classList.add("hidden");
        notVerifiedSection.classList.add("hidden");
        votingSection.classList.remove("hidden");

        // Basic stats
        totalVotesEl.textContent = totalVotes.toString();
        userTotalVotesEl.textContent = userTotalVotes.toString();

        // Show votes LEFT today, not used
        const safeVotesLeft = Math.max(0, votesLeft);
        votesTodayEl.textContent = `${safeVotesLeft}/${MAX_VOTES_PER_DAY}`;

        // ---- Thermometer update ----
        const pctRaw =
          TARGET_VOTES > 0 ? (totalVotes / TARGET_VOTES) * 100 : 0;
        const pct = Math.max(0, Math.min(pctRaw, 100));

        const MERCURY_OFFSET = 7;
        const mercuryPct = Math.max(0, Math.min(pct - MERCURY_OFFSET, 100));

        if (thermoMercury) {
          thermoMercury.style.height = mercuryPct + "%";
        }
        if (thermoCount) {
          thermoCount.textContent = totalVotes.toLocaleString();
        }
        if (thermoPercent) {
          thermoPercent.textContent = `${pct.toFixed(1)}% to target`;
        }
        if (thermoTarget) {
          thermoTarget.textContent = `Target: ${TARGET_VOTES.toLocaleString()} votes`;
        }

        if (thermoFace) {
          const MIN_BOTTOM = 20;
          const MAX_BOTTOM = 340;

          const t = pct / 100;
          const eased = Math.pow(t, 0.6);

          const faceBottom =
            MIN_BOTTOM + (MAX_BOTTOM - MIN_BOTTOM) * eased;

          thermoFace.style.bottom = `${faceBottom}px`;
        }

        // ---- Vote action (button vs "come back later") ----
        voteAction.innerHTML = "";
        voteButtonRef = null;

        if (safeVotesLeft > 0) {
          const btn = document.createElement("button");
          btn.className = "vote-btn";
          btn.setAttribute("aria-label", "Vote");
          btn.addEventListener("click", handleVoteClick);
          voteButtonRef = btn;
          voteAction.appendChild(btn);
        } else {
          const p = document.createElement("p");
          p.className = "no-votes-text";
          p.textContent = `Youâ€™ve used all votes for now. 0/${MAX_VOTES_PER_DAY} votes left. Come back later.`;
          voteAction.appendChild(p);
        }
      }

      async function handleVoteClick() {
        if (!votingContract || !signer || !connectedAddress) {
          alert("Please connect your wallet first.");
          return;
        }

        try {
          if (voteButtonRef) {
            voteButtonRef.classList.add("loading");
          }

          const overrides = {};

          if (voteFeeWei && !voteFeeWei.isZero()) {
            overrides.value = voteFeeWei;
          }

          const tx = await votingContract.vote(overrides);
          console.log("vote tx:", tx.hash);
          await tx.wait();

          alert("Vote successful!");
          await refreshVotingStats();
        } catch (err) {
          console.error("handleVoteClick error:", err);
          const msg =
            (err && err.data && err.data.message) ||
            (err && err.message) ||
            "Voting transaction failed or was rejected.";
          alert(msg);
        } finally {
          if (voteButtonRef) {
            voteButtonRef.classList.remove("loading");
          }
        }
      }

      async function refreshVotingStats() {
        if (!votingContract || !connectedAddress) return;

        try {
          const [userInfo, totalGlobal] = await Promise.all([
            votingContract.getUserInfo(connectedAddress),
            votingContract.totalVotesGlobal()
          ]);

          console.log("refresh userInfo raw:", userInfo);

          const votesTodayUsed = Number(
            userInfo.votesToday !== undefined ? userInfo.votesToday : userInfo[1]
          );
          const userTotalVotes = Number(
            userInfo.totalVotes !== undefined ? userInfo.totalVotes : userInfo[2]
          );
          const votesLeft = Number(
            userInfo.votesLeft !== undefined ? userInfo.votesLeft : userInfo[3]
          );

          showVotingStation(
            Number(totalGlobal),
            userTotalVotes,
            votesTodayUsed,
            votesLeft
          );
        } catch (err) {
          console.error("Error refreshing stats:", err);
        }
      }

      // ---- STUB PoH (to be replaced with real Linea / Sumsub logic) ----
      async function checkPohStub(walletAddress) {
        console.log("Checking PoH for (stub)", walletAddress);
        return true; // flip to false to see "Verify Here" state
      }
    </script>
  </body>
</html>
