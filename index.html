<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Dn Brotato Taterz Farm</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Dn Brotato Taterz Farm" />

    <!-- Use existing logo as favicon to avoid 404 -->
    <link rel="icon" href="assets/images/dnlogo2.png" />

    <style>
      @font-face {
        font-family: "OverstreetBibleBold";
        src: url("assets/fonts/overstreetbiblebold.ttf") format("truetype");
        font-weight: normal;
        font-style: normal;
        font-display: swap;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "OverstreetBibleBold", system-ui, -apple-system,
          BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: #ffffff;
        background: url("assets/images/background2.png") center center / cover
          no-repeat fixed;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .page {
        width: 100%;
        max-width: 1200px;
        padding: 20px 16px 60px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      /* HEADER / LOGO BAR */
      .header {
        width: 100%;
        height: 100px;
        background: transparent;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0;
      }

      .header-link {
        display: inline-block;
      }

      .header-logo {
        height: 80px;
        width: auto;
        transition: transform 0.3s ease;
      }

      .header-logo:hover {
        transform: scale(1.05);
      }

      /* TITLE */
      h1 {
        margin: 60px 0 40px;
        text-align: center;
        font-size: clamp(2.5rem, 5vw, 4.5rem);
        line-height: 1.1;
        text-transform: uppercase;
        text-shadow: 0 3px 6px rgba(0, 0, 0, 0.4);
        color: #000000; /* black title */
      }

      /* CONNECT SECTION */
      .connect-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
      }

      .connect-btn {
        border: none;
        padding: 0;
        background: transparent;
        cursor: pointer;
        display: block;
        width: 260px;
        height: 80px;
        background-image: url("assets/images/connect.png");
        background-position: center;
        background-repeat: no-repeat;
        background-size: contain;
        transition:
          transform 0.15s ease-out,
          background-image 0.15s ease-out;
        will-change: transform;
      }

      .connect-btn:hover {
        background-image: url("assets/images/connecthover.png");
        transform: scale(1.15);
      }

      .connect-btn:active {
        transform: scale(0.98);
      }

      /* Hover text under connect */
      .connect-hover-text {
        margin-top: 16px;
        width: 100%;
        max-width: 600px;
        text-align: center;
        color: #f5f5f5;
        font-size: 2rem;
        opacity: 0;
        transform: translateY(8px);
        transition:
          opacity 0.2s ease-out,
          transform 0.2s ease-out;
        pointer-events: none;
      }

      .connect-wrapper:hover .connect-hover-text {
        opacity: 1;
        transform: translateY(0);
      }

      /* VOTING STATION */
      .voting-station {
        margin-top: 20px;
        width: 100%;
        max-width: 540px; /* narrower center box */
        text-align: center;
        color: #ffffff;
      }

      /* Layout: thermometer on left, vote+claim on right */
      .voting-layout {
        display: flex;
        gap: 24px;
        align-items: flex-start;
        justify-content: center;
      }

      .voting-content {
        flex: 1;
        min-width: 0;
      }

      .voting-title {
        font-size: clamp(2rem, 4vw, 3rem);
        text-transform: uppercase;
        margin-bottom: 16px;
        text-shadow: 0 3px 6px rgba(0, 0, 0, 0.5);
      }

      /* PoH status line */
      .poh-status {
        margin-bottom: 20px;
        font-size: 1.4rem;
      }

      .poh-status-label {
        color: #ffffff;
      }

      .poh-status-yes {
        /* darker forest green */
        color: #1f7a3a;
      }

      .vote-stats {
        display: flex;
        flex-direction: column;
        gap: 12px;
        font-size: 1.4rem;
        margin-bottom: 30px;
      }

      .vote-stat-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(0, 0, 0, 0.45);
        padding: 10px 16px;
        border-radius: 10px;
      }

      .vote-stat-label {
        text-align: left;
      }

      .vote-stat-value {
        text-align: right;
      }

      /* Vote action area */
      .vote-action {
        margin-top: 10px;
        font-size: 1.6rem;
      }

      /* Image-based VOTE button */
      .vote-btn {
        border: none;
        padding: 0;
        background: transparent;
        cursor: pointer;
        display: inline-block;
        width: 220px;
        height: 70px;
        background-image: url("assets/images/vote.png");
        background-position: center;
        background-repeat: no-repeat;
        background-size: contain;
        transition:
          transform 0.15s ease-out,
          background-image 0.15s ease-out;
        will-change: transform;
      }

      .vote-btn:hover {
        background-image: url("assets/images/votehover.png");
        transform: scale(1.15);
      }

      .vote-btn:active {
        transform: scale(0.98);
      }

      .no-votes-text {
        font-size: 1.6rem;
        opacity: 0.9;
      }

      /* Not PoH verified panel */
      .not-verified {
        margin-top: 24px;
        text-align: center;
        font-size: 1.4rem;
      }

      .verify-button {
        margin-top: 12px;
        display: inline-block;
        padding: 10px 24px;
        border-radius: 999px;
        background: #000000;
        color: #ffffff;
        text-decoration: none;
        text-transform: uppercase;
        font-size: 1.2rem;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.6);
      }

      /* LEFT SIDE: VOTE THERMOMETER */
      .thermo-wrapper {
        width: 200px;
        padding: 16px 12px 20px;
        background: rgba(0, 0, 0, 0.6);
        border-radius: 20px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.7);
        text-align: center;
      }

      .thermo-title {
        font-size: 1.4rem;
        text-transform: uppercase;
        margin-bottom: 12px;
      }

      .thermo-body {
        position: relative;
        width: 90px;
        height: 460px; /* tall thermometer */
        margin: 0 auto 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .thermo-column {
        position: relative;
        width: 36px;
        height: 340px;
        margin-top: 6px;
        border-radius: 999px;
        border: 4px solid rgba(255, 255, 255, 0.9);
        overflow: hidden;
        background: linear-gradient(
          to top,
          rgba(255, 255, 255, 0.12),
          rgba(255, 255, 255, 0.25)
        );
      }

      .thermo-mercury {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 0%; /* JS updates this */
        background: linear-gradient(
          to top,
          #12ceec,
          #00ffe8
        );
        box-shadow: 0 0 12px rgba(0, 255, 232, 0.8);
        transition: height 0.6s ease-out;
      }

      .thermo-bulb {
        width: 56px;
        height: 56px;
        border-radius: 999px;
        border: 4px solid rgba(255, 255, 255, 0.95);
        background: radial-gradient(
          circle at 30% 30%,
          #00ffe8,
          #12ceec
        );
        box-shadow: 0 0 18px rgba(0, 255, 232, 0.7);
        margin-top: -6px;
      }

      /* Moving face riding the mercury (Devlan with hair) */
      .thermo-face {
        position: absolute;
        left: 50%;
        width: 78px;
        height: 78px;
        border-radius: 50%;
        transform: translateX(-50%);
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        border: none;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.9);
        bottom: 20px; /* JS will adjust based on percentage */
        transition: bottom 0.6s ease-out;
        z-index: 2;
      }

      .thermo-face img {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        object-fit: contain;
      }

      /* Goal face at the top (Devlan bald) */
      .thermo-face-goal {
        position: absolute;
        left: 50%;
        width: 78px;
        height: 78px;
        border-radius: 50%;
        transform: translateX(-50%);
        top: -6px; /* sits right at the top as the goal */
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        border: none;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.9);
        z-index: 2;
      }

      .thermo-face-goal img {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        object-fit: contain;
      }

      .thermo-labels {
        font-size: 1.05rem;
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      #thermoCount {
        font-size: 1.3rem;
      }

      #thermoPercent {
        font-size: 1rem;
        opacity: 0.9;
      }

      .thermo-target {
        font-size: 0.9rem;
        opacity: 0.7;
      }

      /* CLAIM STATION (inside SAME right-hand box as vote UX) */
      .claim-station {
        margin-top: 30px;
        width: 100%;
        text-align: center;
        color: #ffffff;
      }

      .claim-title {
        font-size: clamp(1.6rem, 3vw, 2.4rem);
        text-transform: uppercase;
        margin-bottom: 16px;
        text-shadow: 0 3px 6px rgba(0, 0, 0, 0.5);
      }

      .claim-stats {
        display: flex;
        flex-direction: column;
        gap: 12px;
        font-size: 1.3rem;
        margin-bottom: 22px;
      }

      .claim-stat-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(0, 0, 0, 0.45);
        padding: 10px 16px;
        border-radius: 10px;
      }

      .claim-stat-label {
        text-align: left;
      }

      .claim-stat-value {
        text-align: right;
      }

      .claim-action {
        margin-top: 6px;
        font-size: 1.4rem;
      }

      /* Image-based CLAIM button (same style as vote) */
      .claim-btn {
        border: none;
        padding: 0;
        background: transparent;
        cursor: pointer;
        display: inline-block;
        width: 220px;
        height: 70px;
        background-image: url("assets/images/claim.png");
        background-position: center;
        background-repeat: no-repeat;
        background-size: contain;
        transition:
          transform 0.15s ease-out,
          background-image 0.15s ease-out;
        will-change: transform;
      }

      .claim-btn:hover {
        background-image: url("assets/images/claimhover.png");
        transform: scale(1.15);
      }

      .claim-btn:active {
        transform: scale(0.98);
      }

      .no-claims-text {
        font-size: 1.4rem;
        opacity: 0.9;
      }

      /* LEADERBOARD (bottom full-width box) */
      .leaderboard {
        margin-top: 50px;
        width: 100%;
        max-width: 540px;
        text-align: center;
        color: #ffffff;
        background: rgba(0, 0, 0, 0.55);
        border-radius: 16px;
        padding: 20px 18px 24px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.7);
      }

      .leaderboard-title {
        font-size: clamp(1.6rem, 3vw, 2.4rem);
        text-transform: uppercase;
        margin-bottom: 16px;
        text-shadow: 0 3px 6px rgba(0, 0, 0, 0.5);
      }

      .leaderboard-table {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .leaderboard-row {
        display: grid;
        grid-template-columns: 1.2fr 1.4fr 0.8fr;
        align-items: center;
        padding: 8px 12px;
        background: rgba(0, 0, 0, 0.45);
        border-radius: 10px;
        font-size: 1.1rem;
      }

      .leaderboard-header {
        font-size: 1.15rem;
        text-transform: uppercase;
        background: rgba(0, 0, 0, 0.7);
      }

      .leaderboard-rank {
        text-align: left;
      }

      .leaderboard-address {
        text-align: center;
      }

      .leaderboard-votes {
        text-align: right;
      }

      .leaderboard-note {
        margin-top: 10px;
        font-size: 0.95rem;
        opacity: 0.8;
      }

      #leaderboardBody {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      @media (max-width: 600px) {
        .header {
          height: 80px;
        }

        .header-logo {
          height: 60px;
        }

        .connect-btn {
          width: 220px;
          height: 70px;
        }

        h1 {
          margin-top: 40px;
        }

        .connect-hover-text {
          font-size: 1.6rem;
        }

        .vote-stats {
          font-size: 1.2rem;
        }

        .vote-btn,
        .no-votes-text {
          font-size: 1.4rem;
        }

        .poh-status {
          font-size: 1.2rem;
        }

        .voting-layout {
          flex-direction: column;
          align-items: center;
        }

        .thermo-wrapper {
          width: 220px;
        }

        .leaderboard {
          max-width: 100%;
        }

        .leaderboard-row {
          grid-template-columns: 0.8fr 1.4fr 0.8fr;
          font-size: 1rem;
        }
      }

      .hidden {
        display: none !important;
      }
    </style>
  </head>

  <body>
    <div class="page">
      <header class="header">
        <a
          href="https://www.davydonothing.com"
          target="_blank"
          rel="noopener noreferrer"
          class="header-link"
        >
          <img
            src="assets/images/dnlogo2.png"
            alt="DN Brotato logo"
            class="header-logo"
          />
        </a>
      </header>

      <h1>DN Voting Platform</h1>

      <!-- STATE 1: CONNECT (shown initially) -->
      <div class="connect-wrapper" id="connectSection">
        <button
          class="connect-btn"
          id="connectWalletButton"
          aria-label="Connect Wallet"
        ></button>

        <div class="connect-hover-text">
          <p>Connect your wallet to vote on SERIOUS topics</p>
        </div>
      </div>

      <!-- STATE 2: NOT POH VERIFIED -->
      <div class="not-verified hidden" id="notVerifiedSection">
        <p>This wallet is not PoH verified yet.</p>
        <a
          href="#"
          target="_blank"
          rel="noopener noreferrer"
          class="verify-button"
          id="verifyLink"
        >
          Verify Here
        </a>
      </div>

      <!-- STATE 3: VOTING STATION -->
      <div class="voting-station hidden" id="votingSection">
        <div class="voting-layout">
          <!-- LEFT: Vote Thermometer -->
          <div class="thermo-wrapper">
            <div class="thermo-title">Vote Heat</div>

            <div class="thermo-body">
              <div class="thermo-column">
                <div class="thermo-mercury" id="thermoMercury"></div>
              </div>
              <div class="thermo-bulb"></div>

              <!-- Goal face (Devlan bald) at the top -->
              <div class="thermo-face-goal">
                <img src="assets/images/DevlanBald.png" alt="Devlan bald" />
              </div>

              <!-- Moving face (Devlan with hair) following the mercury -->
              <div class="thermo-face" id="thermoFace">
                <img src="assets/images/Devlan.png" alt="Devlan face" />
              </div>
            </div>

            <div class="thermo-labels">
              <div id="thermoCount">0</div>
              <div id="thermoPercent">0% to target</div>
              <div class="thermo-target" id="thermoTarget">
                Target: 5,000 votes
              </div>
            </div>
          </div>

          <!-- RIGHT: Vote + Claim in SAME box -->
          <div class="voting-content">
            <div class="voting-title">Voting station</div>

            <!-- PoH status line -->
            <div class="poh-status">
              <span class="poh-status-label">Proof of Humanity verified: </span>
              <span class="poh-status-yes">Yes</span>
            </div>

            <div class="vote-stats">
              <div class="vote-stat-row">
                <div class="vote-stat-label">Total votes</div>
                <div class="vote-stat-value" id="totalVotes">0</div>
              </div>

              <div class="vote-stat-row">
                <div class="vote-stat-label">Your total votes</div>
                <div class="vote-stat-value" id="userTotalVotes">0</div>
              </div>

              <div class="vote-stat-row">
                <div class="vote-stat-label">Votes today</div>
                <div class="vote-stat-value" id="votesToday">0/10</div>
              </div>
            </div>

            <div class="vote-action" id="voteAction"></div>

            <!-- CLAIM STATION -->
            <div class="claim-station hidden" id="claimSection">
              <div class="claim-title">Claim station</div>

              <div class="claim-stats">
                <div class="claim-stat-row">
                  <div class="claim-stat-label">Claimable votes</div>
                  <div class="claim-stat-value" id="claimableVotes">0</div>
                </div>

                <div class="claim-stat-row">
                  <div class="claim-stat-label">Claimable ETH</div>
                  <div class="claim-stat-value" id="claimableEth">0</div>
                </div>

                <div class="claim-stat-row">
                  <div class="claim-stat-label">Claims left today</div>
                  <div class="claim-stat-value" id="claimsToday">0/10</div>
                </div>
              </div>

              <div class="claim-action" id="claimAction"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- LEADERBOARD (bottom full-width box) -->
      <div class="leaderboard" id="leaderboardSection">
        <div class="leaderboard-title">Top Voters</div>

        <div class="leaderboard-table">
          <div class="leaderboard-row leaderboard-header">
            <div class="leaderboard-rank">Rank</div>
            <div class="leaderboard-address">Wallet</div>
            <div class="leaderboard-votes">Votes</div>
          </div>

          <!-- JS fills this -->
          <div id="leaderboardBody"></div>
        </div>

        <div class="leaderboard-note" id="leaderboardNote">
          Loading leaderboard from on-chain votes...
        </div>
      </div>
    </div>

    <!-- Ethers v6 UMD -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js"></script>

    <script>
      // --------- CONFIG ---------
      const VOTING_CONTRACT_ADDRESS =
        "0xF2e347e7E7D86Ec1CD90914514b4Ee7dC09cB2bD";
      const CLAIM_CONTRACT_ADDRESS =
        "0x27d9afD099d947B6D04d2713c2fD357495E13fcd";
      const LINEA_SEPOLIA_CHAIN_ID_HEX = "0xe705"; // 59141
      const TARGET_VOTES = 5000; // goal for thermometer
      const LEADERBOARD_LIMIT = 10; // top N wallets

      // Minimal ABIs
      const votingAbi = [
        "event Voted(address indexed voter,uint64 dayIndex,uint8 votesToday,uint256 userTotalVotes,uint256 totalVotesGlobal)",
        "function maxVotesPerDay() view returns (uint8)",
        "function voteFeeWei() view returns (uint256)",
        "function votesLeftToday(address) view returns (uint8)",
        "function totalVotesOf(address) view returns (uint256)",
        "function getUserInfo(address) view returns (uint64 dayIndex,uint8 votesToday,uint256 totalVotes,uint8 votesLeft)",
        "function totalVotesGlobal() view returns (uint256)",
        "function vote() payable"
      ];

      const claimAbi = [
        "function claim()",
        "function ethPerVoteWei() view returns (uint256)",
        "function maxClaimsPerDay() view returns (uint8)",
        "function claimableVotes(address user) view returns (uint256)",
        "function claimableEth(address user) view returns (uint256)",
        "function getUserClaimInfo(address user) view returns (uint64 dayIndex,uint8 claimsToday,uint256 votesClaimed,uint256 totalVotes,uint256 votesAvailable,uint8 claimsLeftToday)"
      ];

      // --------- DOM ELEMENTS ---------
      const connectSection = document.getElementById("connectSection");
      const notVerifiedSection = document.getElementById("notVerifiedSection");
      const votingSection = document.getElementById("votingSection");
      const claimSection = document.getElementById("claimSection");

      const voteAction = document.getElementById("voteAction");
      const connectWalletButton =
        document.getElementById("connectWalletButton");

      const totalVotesEl = document.getElementById("totalVotes");
      const userTotalVotesEl = document.getElementById("userTotalVotes");
      const votesTodayEl = document.getElementById("votesToday");

      // Thermometer
      const thermoMercury = document.getElementById("thermoMercury");
      const thermoFace = document.getElementById("thermoFace");
      const thermoCount = document.getElementById("thermoCount");
      const thermoPercent = document.getElementById("thermoPercent");
      const thermoTarget = document.getElementById("thermoTarget");

      // Claim station
      const claimableVotesEl = document.getElementById("claimableVotes");
      const claimableEthEl = document.getElementById("claimableEth");
      const claimsTodayEl = document.getElementById("claimsToday");
      const claimAction = document.getElementById("claimAction");

      // Leaderboard
      const leaderboardBody = document.getElementById("leaderboardBody");
      const leaderboardNote = document.getElementById("leaderboardNote");

      // --------- ETHERS STATE ---------
      let provider;
      let signer;
      let signerAddress;
      let votingContract;
      let claimContract;
      let maxVotesPerDay = 10;
      let maxClaimsPerDay = 10;
      let lastVoteFeeWei = 0n;

      // Preload hover images to reduce first-hover glitch
      (function preloadButtons() {
        const imgs = [
          "assets/images/connecthover.png",
          "assets/images/votehover.png",
          "assets/images/claimhover.png"
        ];
        imgs.forEach((src) => {
          const img = new Image();
          img.src = src;
        });
      })();

      // --------- CONNECT BUTTON HANDLER ---------
      connectWalletButton.addEventListener("click", async () => {
        try {
          await connectWalletAndInit();
          const isVerified = await checkPohStub(signerAddress); // PoH stub
          if (!isVerified) {
            showNotVerified();
            return;
          }
          await refreshUi();
        } catch (err) {
          console.error(err);
          alert(
            "Failed to connect wallet: " +
              (err.shortMessage || err.message || "Unknown error")
          );
        }
      });

      // --------- WALLET / NETWORK / CONTRACT INIT ---------
      async function connectWalletAndInit() {
        if (!window.ethereum) {
          alert("No Ethereum wallet found. Please install MetaMask.");
          throw new Error("No window.ethereum");
        }

        await window.ethereum.request({ method: "eth_requestAccounts" });

        let chainId = await window.ethereum.request({ method: "eth_chainId" });
        if (chainId.toLowerCase() !== LINEA_SEPOLIA_CHAIN_ID_HEX) {
          try {
            await window.ethereum.request({
              method: "wallet_switchEthereumChain",
              params: [{ chainId: LINEA_SEPOLIA_CHAIN_ID_HEX }]
            });
          } catch (switchError) {
            if (switchError.code === 4902) {
              await window.ethereum.request({
                method: "wallet_addEthereumChain",
                params: [
                  {
                    chainId: LINEA_SEPOLIA_CHAIN_ID_HEX,
                    chainName: "Linea Sepolia",
                    rpcUrls: ["https://rpc.sepolia.linea.build"],
                    nativeCurrency: {
                      name: "Linea Sepolia ETH",
                      symbol: "ETH",
                      decimals: 18
                    },
                    blockExplorerUrls: ["https://sepolia.lineascan.build"]
                  }
                ]
              });
            } else {
              throw switchError;
            }
          }
        }

        provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();
        signerAddress = await signer.getAddress();

        votingContract = new ethers.Contract(
          VOTING_CONTRACT_ADDRESS,
          votingAbi,
          signer
        );
        claimContract = new ethers.Contract(
          CLAIM_CONTRACT_ADDRESS,
          claimAbi,
          signer
        );

        const [maxVotesBn, maxClaimsBn] = await Promise.all([
          votingContract.maxVotesPerDay(),
          claimContract.maxClaimsPerDay()
        ]);

        maxVotesPerDay = Number(maxVotesBn);
        maxClaimsPerDay = Number(maxClaimsBn);
      }

      // --------- UI STATE FUNCTIONS ---------
      function showNotVerified() {
        connectSection.classList.add("hidden");
        votingSection.classList.add("hidden");
        claimSection.classList.add("hidden");
        notVerifiedSection.classList.remove("hidden");
      }

      async function refreshUi() {
        if (!votingContract || !claimContract || !signerAddress) return;

        const [
          voteFeeWeiBn,
          userInfo,
          totalVotesGlobalBn,
          userClaimInfo,
          claimableEthWeiBn
        ] = await Promise.all([
          votingContract.voteFeeWei(),
          votingContract.getUserInfo(signerAddress),
          votingContract.totalVotesGlobal(),
          claimContract.getUserClaimInfo(signerAddress),
          claimContract.claimableEth(signerAddress)
        ]);

        lastVoteFeeWei = voteFeeWeiBn;

        const totalVotesGlobal = Number(totalVotesGlobalBn);
        const userTotalVotes = Number(userInfo.totalVotes);
        const votesTodayUsed = Number(userInfo.votesToday);
        const votesRemaining = Math.max(0, maxVotesPerDay - votesTodayUsed);

        updateVotingSection(
          totalVotesGlobal,
          userTotalVotes,
          votesTodayUsed,
          votesRemaining
        );

        const claimableVotes = Number(userClaimInfo.votesAvailable);
        const claimsLeftToday = Number(userClaimInfo.claimsLeftToday);
        const claimableEthStr = ethers.formatEther(claimableEthWeiBn);

        updateClaimSection(claimableVotes, claimableEthStr, claimsLeftToday);

        // Also update leaderboard from on-chain events
        await loadLeaderboard();
      }

      function updateVotingSection(
        totalVotesGlobal,
        userTotalVotes,
        votesTodayUsed,
        votesRemaining
      ) {
        connectSection.classList.add("hidden");
        notVerifiedSection.classList.add("hidden");
        votingSection.classList.remove("hidden");

        totalVotesEl.textContent = totalVotesGlobal.toLocaleString();
        userTotalVotesEl.textContent = userTotalVotes.toLocaleString();
        votesTodayEl.textContent = `${votesRemaining}/${maxVotesPerDay}`;

        const pctRaw =
          TARGET_VOTES > 0 ? (totalVotesGlobal / TARGET_VOTES) * 100 : 0;
        const pct = Math.max(0, Math.min(pctRaw, 100));

        const MERCURY_OFFSET = 7;
        const mercuryPct = Math.max(0, Math.min(pct - MERCURY_OFFSET, 100));

        if (thermoMercury) {
          thermoMercury.style.height = mercuryPct + "%";
        }
        if (thermoCount) {
          thermoCount.textContent = totalVotesGlobal.toLocaleString();
        }
        if (thermoPercent) {
          thermoPercent.textContent = `${pct.toFixed(1)}% to target`;
        }
        if (thermoTarget) {
          thermoTarget.textContent = `Target: ${TARGET_VOTES.toLocaleString()} votes`;
        }

        if (thermoFace) {
          const MIN_BOTTOM = 20;
          const MAX_BOTTOM = 340;

          const t = pct / 100;
          const eased = Math.pow(t, 0.6);

          const faceBottom =
            MIN_BOTTOM + (MAX_BOTTOM - MIN_BOTTOM) * eased;

          thermoFace.style.bottom = `${faceBottom}px`;
        }

        voteAction.innerHTML = "";

        if (votesRemaining > 0) {
          const btn = document.createElement("button");
          btn.className = "vote-btn";
          btn.setAttribute("aria-label", "Vote");
          btn.addEventListener("click", handleVoteClick);
          voteAction.appendChild(btn);
        } else {
          const p = document.createElement("p");
          p.className = "no-votes-text";
          p.textContent = "You’ve used all votes for now. Come back later.";
          voteAction.appendChild(p);
        }
      }

      function updateClaimSection(
        claimableVotes,
        claimableEthStr,
        claimsLeftToday
      ) {
        claimSection.classList.remove("hidden");

        claimableVotesEl.textContent = claimableVotes.toLocaleString();

        const ethNum = Number(claimableEthStr);
        const prettyEth =
          !isNaN(ethNum) && ethNum > 0
            ? ethNum.toFixed(6)
            : "0.000000";

        claimableEthEl.textContent = `${prettyEth} ETH`;
        claimsTodayEl.textContent = `${claimsLeftToday}/${maxClaimsPerDay}`;

        claimAction.innerHTML = "";

        if (claimableVotes > 0 && claimsLeftToday > 0) {
          const btn = document.createElement("button");
          btn.className = "claim-btn";
          btn.setAttribute("aria-label", "Claim");
          btn.addEventListener("click", handleClaimClick);
          claimAction.appendChild(btn);
        } else if (claimableVotes === 0 && claimsLeftToday > 0) {
          const p = document.createElement("p");
          p.className = "no-claims-text";
          p.textContent =
            "No claimable votes yet. Cast more votes to unlock claims.";
          claimAction.appendChild(p);
        } else if (claimsLeftToday === 0) {
          const p = document.createElement("p");
          p.className = "no-claims-text";
          p.textContent =
            "You’ve used all claims for this 24-hour window. Come back later.";
          claimAction.appendChild(p);
        }
      }

      // --------- LEADERBOARD (from Voted events) ---------
      function shortenAddress(addr) {
        if (!addr || addr.length < 10) return addr;
        return addr.slice(0, 6) + "..." + addr.slice(-4);
      }

      async function loadLeaderboard() {
        if (!votingContract || !leaderboardBody) return;

        try {
          leaderboardNote.textContent =
            "Loading leaderboard from on-chain votes...";

          const filter = votingContract.filters.Voted();
          // fromBlock can be tuned later to the deployment block if needed
          const logs = await votingContract.queryFilter(filter, 0, "latest");

          const map = new Map(); // address -> BigInt totalVotes

          for (const log of logs) {
            const args = log.args;
            if (!args) continue;
            const voter = args.voter;
            const userTotalVotes = args.userTotalVotes;
            // Keep the latest totalVotes we see (events are in ascending block order)
            map.set(voter, userTotalVotes);
          }

          const entries = Array.from(map.entries()).map(([addr, total]) => ({
            address: addr,
            totalVotes: BigInt(total.toString())
          }));

          entries.sort((a, b) => {
            if (a.totalVotes === b.totalVotes) return 0;
            return a.totalVotes > b.totalVotes ? -1 : 1;
          });

          const top = entries.slice(0, LEADERBOARD_LIMIT);

          leaderboardBody.innerHTML = "";

          if (top.length === 0) {
            leaderboardNote.textContent =
              "No votes yet. Be the first degens to push Devlan to the top.";
            return;
          }

          top.forEach((item, index) => {
            const row = document.createElement("div");
            row.className = "leaderboard-row";

            const rank = document.createElement("div");
            rank.className = "leaderboard-rank";
            rank.textContent = "#" + (index + 1);

            const addr = document.createElement("div");
            addr.className = "leaderboard-address";
            addr.textContent = shortenAddress(item.address);

            const votes = document.createElement("div");
            votes.className = "leaderboard-votes";
            votes.textContent = item.totalVotes.toString();

            row.appendChild(rank);
            row.appendChild(addr);
            row.appendChild(votes);

            leaderboardBody.appendChild(row);
          });

          leaderboardNote.textContent =
            "Leaderboard updates automatically as votes are cast.";
        } catch (err) {
          console.error("Leaderboard error:", err);
          leaderboardNote.textContent =
            "Unable to load leaderboard from chain right now.";
        }
      }

      // --------- VOTE / CLAIM HANDLERS ---------
      async function handleVoteClick() {
        if (!votingContract) return;
        try {
          const btn = document.querySelector(".vote-btn");
          if (btn) {
            btn.disabled = true;
            btn.style.opacity = "0.6";
          }

          const overrides =
            lastVoteFeeWei && lastVoteFeeWei > 0n
              ? { value: lastVoteFeeWei }
              : {};

          const tx = await votingContract.vote(overrides);
          await tx.wait();

          await refreshUi();
        } catch (err) {
          console.error(err);
          alert(
            "Vote failed: " +
              (err.shortMessage || err.message || "Unknown error")
          );
        } finally {
          const btn = document.querySelector(".vote-btn");
          if (btn) {
            btn.disabled = false;
            btn.style.opacity = "1";
          }
        }
      }

      async function handleClaimClick() {
        if (!claimContract) return;
        try {
          const btn = document.querySelector(".claim-btn");
          if (btn) {
            btn.disabled = true;
            btn.style.opacity = "0.6";
          }

          const tx = await claimContract.claim();
          await tx.wait();

          await refreshUi();
        } catch (err) {
          console.error(err);
          alert(
            "Claim failed: " +
              (err.shortMessage || err.message || "Unknown error")
          );
        } finally {
          const btn = document.querySelector(".claim-btn");
          if (btn) {
            btn.disabled = false;
            btn.style.opacity = "1";
          }
        }
      }

      // --------- PoH STUB (always true for now) ---------
      async function checkPohStub(_walletAddress) {
        return true;
      }
    </script>
  </body>
</html>
