<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Dn Brotato Taterz Farm</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Dn Brotato Taterz Farm" />

    <!-- If this 404s you can remove or point to a real icon -->
    <link rel="icon" href="fabicon.png" />

    <style>
      @font-face {
        font-family: "OverstreetBibleBold";
        src: url("assets/fonts/overstreetbiblebold.ttf") format("truetype");
        font-weight: normal;
        font-style: normal;
        font-display: swap;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "OverstreetBibleBold", system-ui, -apple-system,
          BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: #ffffff;
        background: url("assets/images/background2.png") center center / cover
          no-repeat fixed;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .page {
        width: 100%;
        max-width: 1200px;
        padding: 20px 16px 60px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      /* HEADER / LOGO BAR */
      .header {
        width: 100%;
        height: 100px;
        background: transparent;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0;
      }

      .header-link {
        display: inline-block;
      }

      .header-logo {
        height: 80px;
        width: auto;
        transition: transform 0.3s ease;
      }

      .header-logo:hover {
        transform: scale(1.05);
      }

      /* TITLE */
      h1 {
        margin: 60px 0 40px;
        text-align: center;
        font-size: clamp(2.5rem, 5vw, 4.5rem);
        line-height: 1.1;
        text-transform: uppercase;
        text-shadow: 0 3px 6px rgba(0, 0, 0, 0.4);
        color: #000000; /* black title */
      }

      /* CONNECT SECTION */
      .connect-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
      }

      .connect-btn {
        border: none;
        padding: 0;
        background: transparent;
        cursor: pointer;
        display: block;
        width: 260px;
        height: 80px;
        background-image: url("assets/images/connect.png");
        background-position: center;
        background-repeat: no-repeat;
        background-size: contain;
        transition:
          transform 0.15s ease-out,
          background-image 0.15s ease-out;
      }

      .connect-btn:hover {
        background-image: url("assets/images/connecthover.png");
        transform: scale(1.15);
      }

      .connect-btn:active {
        transform: scale(0.98);
      }

      /* Hover text under connect */
      .connect-hover-text {
        margin-top: 16px;
        width: 100%;
        max-width: 600px;
        text-align: center;
        color: #f5f5f5;
        font-size: 2rem;
        opacity: 0;
        transform: translateY(8px);
        transition:
          opacity 0.2s ease-out,
          transform 0.2s ease-out;
        pointer-events: none;
      }

      .connect-wrapper:hover .connect-hover-text {
        opacity: 1;
        transform: translateY(0);
      }

      /* VOTING STATION */
      .voting-station {
        margin-top: 20px;
        width: 100%;
        max-width: 540px;
        text-align: center;
        color: #ffffff;
      }

      .voting-layout {
        display: flex;
        gap: 24px;
        align-items: flex-start;
        justify-content: center;
      }

      .voting-content {
        flex: 1;
        min-width: 0;
      }

      .voting-title {
        font-size: clamp(2rem, 4vw, 3rem);
        text-transform: uppercase;
        margin-bottom: 16px;
        text-shadow: 0 3px 6px rgba(0, 0, 0, 0.5);
      }

      /* PoH status line */
      .poh-status {
        margin-bottom: 20px;
        font-size: 1.4rem;
      }

      .poh-status-label {
        color: #ffffff;
      }

      .poh-status-yes {
        color: #1f7a3a;
      }

      .poh-status-no {
        color: #ff5c5c;
      }

      .vote-stats {
        display: flex;
        flex-direction: column;
        gap: 12px;
        font-size: 1.4rem;
        margin-bottom: 30px;
      }

      .vote-stat-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(0, 0, 0, 0.45);
        padding: 10px 16px;
        border-radius: 10px;
      }

      .vote-stat-label {
        text-align: left;
      }

      .vote-stat-value {
        text-align: right;
      }

      .vote-action {
        margin-top: 10px;
        font-size: 1.6rem;
      }

      .vote-btn {
        border: none;
        padding: 0;
        background: transparent;
        cursor: pointer;
        display: inline-block;
        width: 220px;
        height: 70px;
        background-image: url("assets/images/vote.png");
        background-position: center;
        background-repeat: no-repeat;
        background-size: contain;
        transition:
          transform 0.15s ease-out,
          background-image 0.15s ease-out;
      }

      .vote-btn:hover {
        background-image: url("assets/images/votehover.png");
        transform: scale(1.15);
      }

      .vote-btn:active {
        transform: scale(0.98);
      }

      .no-votes-text {
        font-size: 1.4rem;
        opacity: 0.95;
        line-height: 1.3;
      }

      /* Not PoH verified panel */
      .not-verified {
        margin-top: 40px;
        text-align: center;
        font-size: 1.4rem;
      }

      .not-verified p {
        margin-bottom: 18px;
      }

      .verify-btn {
        border: none;
        padding: 0;
        background: transparent;
        cursor: pointer;
        display: inline-block;
        width: 260px;
        height: 80px;
        background-image: url("assets/images/verifyhere.png");
        background-position: center;
        background-repeat: no-repeat;
        background-size: contain;
        transition:
          transform 0.15s ease-out,
          background-image 0.15s ease-out;
      }

      .verify-btn:hover {
        background-image: url("assets/images/verifyherehover.png");
        transform: scale(1.15);
      }

      .verify-btn:active {
        transform: scale(0.98);
      }

      /* LEFT SIDE: VOTE THERMOMETER */
      .thermo-wrapper {
        width: 200px;
        padding: 16px 12px 20px;
        background: rgba(0, 0, 0, 0.6);
        border-radius: 20px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.7);
        text-align: center;
      }

      .thermo-title {
        font-size: 1.4rem;
        text-transform: uppercase;
        margin-bottom: 12px;
      }

      .thermo-body {
        position: relative;
        width: 90px;
        height: 460px;
        margin: 0 auto 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .thermo-column {
        position: relative;
        width: 36px;
        height: 340px;
        margin-top: 6px;
        border-radius: 999px;
        border: 4px solid rgba(255, 255, 255, 0.9);
        overflow: hidden;
        background: linear-gradient(
          to top,
          rgba(255, 255, 255, 0.12),
          rgba(255, 255, 255, 0.25)
        );
      }

      .thermo-mercury {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 0%;
        background: linear-gradient(
          to top,
          #12ceec,
          #00ffe8
        );
        box-shadow: 0 0 12px rgba(0, 255, 232, 0.8);
        transition: height 0.6s ease-out;
      }

      .thermo-bulb {
        width: 56px;
        height: 56px;
        border-radius: 999px;
        border: 4px solid rgba(255, 255, 255, 0.95);
        background: radial-gradient(
          circle at 30% 30%,
          #00ffe8,
          #12ceec
        );
        box-shadow: 0 0 18px rgba(0, 255, 232, 0.7);
        margin-top: -6px;
      }

      .thermo-face {
        position: absolute;
        left: 50%;
        width: 78px;
        height: 78px;
        border-radius: 50%;
        transform: translateX(-50%);
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        border: none;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.9);
        bottom: 20px;
        transition: bottom 0.6s ease-out;
        z-index: 2;
      }

      .thermo-face img {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        object-fit: contain;
      }

      .thermo-face-goal {
        position: absolute;
        left: 50%;
        width: 78px;
        height: 78px;
        border-radius: 50%;
        transform: translateX(-50%);
        top: -6px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        border: none;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.9);
        z-index: 2;
      }

      .thermo-face-goal img {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        object-fit: contain;
      }

      .thermo-labels {
        font-size: 1.05rem;
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      #thermoCount {
        font-size: 1.3rem;
      }

      #thermoPercent {
        font-size: 1rem;
        opacity: 0.9;
      }

      .thermo-target {
        font-size: 0.9rem;
        opacity: 0.7;
      }

      /* CLAIM STATION */
      .claim-station {
        margin-top: 36px;
        text-align: left;
      }

      .claim-title {
        font-size: clamp(1.6rem, 3vw, 2.2rem);
        text-transform: uppercase;
        margin-bottom: 12px;
        text-shadow: 0 3px 6px rgba(0, 0, 0, 0.5);
      }

      .claim-stats {
        display: flex;
        flex-direction: column;
        gap: 10px;
        font-size: 1.3rem;
        margin-bottom: 24px;
      }

      .claim-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(0, 0, 0, 0.45);
        padding: 8px 14px;
        border-radius: 10px;
      }

      .claim-label {
        text-align: left;
      }

      .claim-value {
        text-align: right;
      }

      .claim-action {
        margin-top: 8px;
        font-size: 1.4rem;
      }

      .claim-btn {
        border: none;
        padding: 0;
        background: transparent;
        cursor: pointer;
        display: inline-block;
        width: 220px;
        height: 70px;
        background-image: url("assets/images/claim.png");
        background-position: center;
        background-repeat: no-repeat;
        background-size: contain;
        transition:
          transform 0.15s ease-out,
          background-image 0.15s ease-out;
      }

      .claim-btn:hover {
        background-image: url("assets/images/claimhover.png");
        transform: scale(1.15);
      }

      .claim-btn:active {
        transform: scale(0.98);
      }

      .no-claims-text {
        font-size: 1.4rem;
        opacity: 0.95;
      }

      /* LEADERBOARD */
      .leaderboard {
        margin-top: 60px;
        width: 100%;
        max-width: 700px;
        background: rgba(0, 0, 0, 0.65);
        border-radius: 18px;
        padding: 20px 18px 24px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.7);
      }

      .leaderboard-title {
        text-align: center;
        font-size: clamp(1.8rem, 3.5vw, 2.4rem);
        text-transform: uppercase;
        margin-bottom: 6px;
      }

      .leaderboard-subtitle {
        text-align: center;
        font-size: 1rem;
        opacity: 0.8;
        margin-bottom: 16px;
      }

      .leaderboard-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 1.1rem;
      }

      .leaderboard-table thead {
        font-size: 0.95rem;
        text-transform: uppercase;
        opacity: 0.7;
      }

      .leaderboard-table th,
      .leaderboard-table td {
        padding: 8px 6px;
        text-align: left;
      }

      .leaderboard-table tbody tr:nth-child(odd) {
        background: rgba(255, 255, 255, 0.04);
      }

      .leaderboard-rank {
        width: 40px;
      }

      .leaderboard-address {
        font-family: monospace;
        font-size: 0.95rem;
      }

      .leaderboard-tag {
        font-size: 0.9rem;
        opacity: 0.8;
      }

      @media (max-width: 600px) {
        .header {
          height: 80px;
        }

        .header-logo {
          height: 60px;
        }

        .connect-btn {
          width: 220px;
          height: 70px;
        }

        h1 {
          margin-top: 40px;
        }

        .connect-hover-text {
          font-size: 1.6rem;
        }

        .vote-stats {
          font-size: 1.2rem;
        }

        .vote-btn,
        .no-votes-text {
          font-size: 1.4rem;
        }

        .poh-status {
          font-size: 1.2rem;
        }

        .voting-layout {
          flex-direction: column;
          align-items: center;
        }

        .thermo-wrapper {
          width: 220px;
        }

        .leaderboard {
          margin-top: 40px;
        }
      }

      .hidden {
        display: none !important;
      }
    </style>
  </head>

  <body>
    <div class="page">
      <header class="header">
        <a
          href="https://www.davydonothing.com"
          target="_blank"
          rel="noopener noreferrer"
          class="header-link"
        >
          <img
            src="assets/images/dnlogo2.png"
            alt="DN Brotato logo"
            class="header-logo"
          />
        </a>
      </header>

      <h1>DN Voting Platform</h1>

      <!-- STATE 1: CONNECT -->
      <div class="connect-wrapper" id="connectSection">
        <button
          class="connect-btn"
          id="connectWalletButton"
          aria-label="Connect Wallet"
        ></button>

        <div class="connect-hover-text">
          <p>Connect your wallet to vote on SERIOUS topics</p>
        </div>
      </div>

      <!-- STATE 2: NOT PoH VERIFIED -->
      <div class="not-verified hidden" id="notVerifiedSection">
        <p>
          This wallet is not Proof of Humanity verified yet. Verify to start
          causing hair-related damage.
        </p>
        <button class="verify-btn" id="verifyHereButton" aria-label="Verify Here"></button>
      </div>

      <!-- STATE 3: VOTING & CLAIM STATION -->
      <div class="voting-station hidden" id="votingSection">
        <div class="voting-layout">
          <!-- LEFT: Thermometer -->
          <div class="thermo-wrapper">
            <div class="thermo-title">Vote Heat</div>

            <div class="thermo-body">
              <div class="thermo-column">
                <div class="thermo-mercury" id="thermoMercury"></div>
              </div>
              <div class="thermo-bulb"></div>

              <div class="thermo-face-goal">
                <img src="assets/images/devlanbald.png" alt="Devlan bald" />
              </div>

              <div class="thermo-face" id="thermoFace">
                <img src="assets/images/devlan.png" alt="Devlan face" />
              </div>
            </div>

            <div class="thermo-labels">
              <div id="thermoCount">0</div>
              <div id="thermoPercent">0% to target</div>
              <div class="thermo-target" id="thermoTarget">
                Target: 5,000 votes
              </div>
            </div>
          </div>

          <!-- RIGHT: Voting + Claim -->
          <div class="voting-content">
            <div class="voting-title">Voting station</div>

            <div class="poh-status">
              <span class="poh-status-label">Proof of Humanity verified: </span>
              <span id="pohStatus" class="poh-status-yes">Yes</span>
            </div>

            <div class="vote-stats">
              <div class="vote-stat-row">
                <div class="vote-stat-label">Total votes</div>
                <div class="vote-stat-value" id="totalVotes">0</div>
              </div>

              <div class="vote-stat-row">
                <div class="vote-stat-label">Your total votes</div>
                <div class="vote-stat-value" id="userTotalVotes">0</div>
              </div>

              <div class="vote-stat-row">
                <div class="vote-stat-label">Votes today</div>
                <div class="vote-stat-value" id="votesToday">0/10</div>
              </div>
            </div>

            <div class="vote-action" id="voteAction"></div>

            <!-- CLAIM STATION -->
            <div class="claim-station">
              <div class="claim-title">Claim station</div>

              <div class="claim-stats">
                <div class="claim-row">
                  <div class="claim-label">Available claims</div>
                  <div class="claim-value" id="availableClaims">0</div>
                </div>
                <div class="claim-row">
                  <div class="claim-label">Claims left today</div>
                  <div class="claim-value" id="claimsToday">0/10</div>
                </div>
              </div>

              <div class="claim-action" id="claimAction"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- LEADERBOARD -->
      <div class="leaderboard" id="leaderboardSection">
        <div class="leaderboard-title">Top Brotato Voters</div>
        <div class="leaderboard-subtitle">
          The bravest hair saboteurs in the ecosystem.
        </div>
        <table class="leaderboard-table">
          <thead>
            <tr>
              <th class="leaderboard-rank">#</th>
              <th>Address</th>
              <th>Votes</th>
              <th>Tag</th>
            </tr>
          </thead>
          <tbody id="leaderboardBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Ethers v6 UMD -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js"></script>

    <script>
      const { BrowserProvider, Contract } = ethers;

      // DOM elements
      const connectSection = document.getElementById("connectSection");
      const notVerifiedSection = document.getElementById("notVerifiedSection");
      const votingSection = document.getElementById("votingSection");
      const voteAction = document.getElementById("voteAction");
      const claimAction = document.getElementById("claimAction");

      const totalVotesEl = document.getElementById("totalVotes");
      const userTotalVotesEl = document.getElementById("userTotalVotes");
      const votesTodayEl = document.getElementById("votesToday");

      const availableClaimsEl = document.getElementById("availableClaims");
      const claimsTodayEl = document.getElementById("claimsToday");

      const connectWalletButton = document.getElementById("connectWalletButton");
      const verifyHereButton = document.getElementById("verifyHereButton");
      const pohStatusEl = document.getElementById("pohStatus");

      const thermoMercury = document.getElementById("thermoMercury");
      const thermoFace = document.getElementById("thermoFace");
      const thermoCount = document.getElementById("thermoCount");
      const thermoPercent = document.getElementById("thermoPercent");
      const thermoTarget = document.getElementById("thermoTarget");

      const leaderboardBody = document.getElementById("leaderboardBody");

      // Config
      const MAX_VOTES_PER_DAY_DEFAULT = 10;
      const MAX_CLAIMS_PER_DAY = 10;
      const TARGET_VOTES = 5000;

      const VOTE_CONTRACT_ADDRESS =
        "0xF2e347e7E7D86Ec1CD90914514b4Ee7dC09cB2bD";
      const CLAIM_CONTRACT_ADDRESS =
        "0x27d9afD099d947B6D04d2713c2fD357495E13fcd";

      const VOTE_ABI = [
        "function getUserInfo(address user) view returns (uint64 dayIndex, uint8 votesToday, uint256 totalVotes, uint8 votesLeft)",
        "function totalVotesGlobal() view returns (uint256)",
        "function maxVotesPerDay() view returns (uint8)",
        "function voteFeeWei() view returns (uint256)",
        "function vote() payable"
      ];

      const CLAIM_ABI = [
        "function claimableVotes(address user) view returns (uint256)",
        "function claimsLeftToday(address user) view returns (uint8)",
        "function claimOnce()"
      ];

      const POH_ADDRESSES = new Set([
        "0x54115a13047fb10c3d5849fff1b23efaa010ce09"
      ]);

      let provider;
      let signer;
      let voteContract;
      let claimContract;
      let currentWallet = null;

      function isPohVerified(address) {
        if (!address) return false;
        return POH_ADDRESSES.has(address.toLowerCase());
      }

      function setPohStatus(isVerified) {
        if (!pohStatusEl) return;
        pohStatusEl.textContent = isVerified ? "Yes" : "No";
        pohStatusEl.classList.toggle("poh-status-yes", isVerified);
        pohStatusEl.classList.toggle("poh-status-no", !isVerified);
      }

      function showConnectOnly() {
        connectSection.classList.remove("hidden");
        notVerifiedSection.classList.add("hidden");
        votingSection.classList.add("hidden");
      }

      function showNotVerified() {
        connectSection.classList.add("hidden");
        votingSection.classList.add("hidden");
        notVerifiedSection.classList.remove("hidden");
        setPohStatus(false);
      }

      function showVotingStationWrapper(stats) {
        connectSection.classList.add("hidden");
        notVerifiedSection.classList.add("hidden");
        votingSection.classList.remove("hidden");
        setPohStatus(true);

        console.log("Vote + claim stats:", stats);
        showVotingStation(stats);
      }

      function secondsUntilNextDayFromDayIndex(userDayIndex) {
        const nowSec = Math.floor(Date.now() / 1000);
        const todayIndex = Math.floor(nowSec / 86400);

        if (userDayIndex < todayIndex) {
          return 0;
        }

        const nextReset = (todayIndex + 1) * 86400;
        const diff = nextReset - nowSec;
        return diff > 0 ? diff : 0;
      }

      function formatCooldown(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        return { hours, minutes };
      }

      function shortenAddress(addr) {
        if (!addr || addr.length < 10) return addr || "";
        return addr.slice(0, 6) + "..." + addr.slice(-4);
      }

      const mockLeaders = [
        {
          rank: 1,
          address: "0x54115A13047fB10C3D5849fFF1b23EFAa010CE09",
          votes: 42,
          tag: "Hair Nemesis"
        },
        {
          rank: 2,
          address: "0x1234000000000000000000000000000000BEEF",
          votes: 24,
          tag: "Follicle Foe"
        },
        {
          rank: 3,
          address: "0x9999000000000000000000000000000000DEAD",
          votes: 17,
          tag: "Clipper Casual"
        }
      ];

      function renderLeaderboard(rows) {
        leaderboardBody.innerHTML = "";
        rows.forEach(row => {
          const tr = document.createElement("tr");

          const tdRank = document.createElement("td");
          tdRank.className = "leaderboard-rank";
          tdRank.textContent = row.rank;

          const tdAddr = document.createElement("td");
          tdAddr.className = "leaderboard-address";
          tdAddr.textContent = shortenAddress(row.address);

          const tdVotes = document.createElement("td");
          tdVotes.textContent = row.votes.toString();

          const tdTag = document.createElement("td");
          tdTag.className = "leaderboard-tag";
          tdTag.textContent = row.tag || "";

          tr.appendChild(tdRank);
          tr.appendChild(tdAddr);
          tr.appendChild(tdVotes);
          tr.appendChild(tdTag);
          leaderboardBody.appendChild(tr);
        });
      }

      function showVotingStation(stats) {
        const {
          totalVotesGlobal,
          userTotalVotes,
          votesLeftToday,
          maxVotesPerDay,
          dayIndex,
          claimableVotes,
          claimsLeftToday
        } = stats;

        totalVotesEl.textContent = totalVotesGlobal.toLocaleString();
        userTotalVotesEl.textContent = userTotalVotes.toLocaleString();
        votesTodayEl.textContent = `${votesLeftToday}/${
          maxVotesPerDay || MAX_VOTES_PER_DAY_DEFAULT
        }`;

        const pctRaw =
          TARGET_VOTES > 0 ? (totalVotesGlobal / TARGET_VOTES) * 100 : 0;
        const pct = Math.max(0, Math.min(pctRaw, 100));

        const MERCURY_OFFSET = 7;
        const mercuryPct = Math.max(0, Math.min(pct - MERCURY_OFFSET, 100));

        if (thermoMercury) {
          thermoMercury.style.height = mercuryPct + "%";
        }
        if (thermoCount) {
          thermoCount.textContent = totalVotesGlobal.toLocaleString();
        }
        if (thermoPercent) {
          thermoPercent.textContent = `${pct.toFixed(1)}% to target`;
        }
        if (thermoTarget) {
          thermoTarget.textContent = `Target: ${TARGET_VOTES.toLocaleString()} votes`;
        }

        if (thermoFace) {
          const MIN_BOTTOM = 20;
          const MAX_BOTTOM = 340;
          const t = pct / 100;
          const eased = Math.pow(t, 0.6);
          const faceBottom = MIN_BOTTOM + (MAX_BOTTOM - MIN_BOTTOM) * eased;
          thermoFace.style.bottom = `${faceBottom}px`;
        }

        // VOTE ACTION
        voteAction.innerHTML = "";
        if (votesLeftToday > 0) {
          const btn = document.createElement("button");
          btn.className = "vote-btn";
          btn.setAttribute("aria-label", "Vote");
          btn.addEventListener("click", handleVoteClick);
          voteAction.appendChild(btn);
        } else {
          const seconds = secondsUntilNextDayFromDayIndex(dayIndex);
          const { hours, minutes } = formatCooldown(seconds);

          const p = document.createElement("p");
          p.className = "no-votes-text";

          if (seconds <= 0) {
            p.textContent =
              "Woah there brotato, time to Do Nothing. You can vote again very soon.";
          } else {
            p.textContent = `Woah there brotato, time to Do Nothing, you can vote again in ${hours} hours ${minutes} minutes`;
          }
          voteAction.appendChild(p);
        }

        // CLAIM STATION
        availableClaimsEl.textContent = claimableVotes.toString();
        claimsTodayEl.textContent = `${claimsLeftToday}/${MAX_CLAIMS_PER_DAY}`;

        claimAction.innerHTML = "";
        if (claimableVotes > 0 && claimsLeftToday > 0) {
          const btn = document.createElement("button");
          btn.className = "claim-btn";
          btn.setAttribute("aria-label", "Claim");
          btn.addEventListener("click", handleClaimClick);
          claimAction.appendChild(btn);
        } else {
          const p = document.createElement("p");
          p.className = "no-claims-text";
          p.textContent = "No claims available right now.";
          claimAction.appendChild(p);
        }
      }

      async function ensureProvider() {
        if (!window.ethereum) {
          alert("No wallet found. Please install MetaMask or a compatible wallet.");
          throw new Error("no ethereum");
        }

        if (!provider) {
          provider = new BrowserProvider(window.ethereum);
        }
        if (!signer) {
          signer = await provider.getSigner();
        }

        const network = await provider.getNetwork();
        if (network.chainId !== 59141n) {
          alert("Please switch your wallet to Linea Sepolia (chainId 59141).");
          throw new Error("wrong network");
        }

        if (!voteContract) {
          voteContract = new Contract(VOTE_CONTRACT_ADDRESS, VOTE_ABI, signer);
        }

        if (!claimContract) {
          claimContract = new Contract(
            CLAIM_CONTRACT_ADDRESS,
            CLAIM_ABI,
            signer
          );
        }
      }

      async function connectWallet() {
        await ensureProvider();
        const accounts = await window.ethereum.request({
          method: "eth_requestAccounts"
        });
        if (!accounts || !accounts.length) {
          throw new Error("No account returned");
        }
        currentWallet = accounts[0];
        return currentWallet;
      }

      async function loadVoteAndClaimStats(walletAddress) {
        await ensureProvider();

        const [userInfo, totalVotesGlobal, maxVotesPerDayOnChain] =
          await Promise.all([
            voteContract.getUserInfo(walletAddress),
            voteContract.totalVotesGlobal(),
            voteContract.maxVotesPerDay()
          ]);

        const [dayIndex, votesToday, userTotalVotes, votesLeftToday] = userInfo;

        let claimableVotes = 0;
        let claimsLeftToday = 0;

        try {
          if (claimContract) {
            const [claimableVotesRaw, claimsLeftTodayRaw] = await Promise.all([
              claimContract.claimableVotes(walletAddress),
              claimContract.claimsLeftToday(walletAddress)
            ]);
            claimableVotes = Number(claimableVotesRaw);
            claimsLeftToday = Number(claimsLeftTodayRaw);
          }
        } catch (e) {
          console.warn(
            "Claim contract view calls failed, using optimistic defaults:",
            e
          );
          // Optimistic fallback: user may have up to userTotalVotes claims, and up to daily cap.
          claimableVotes = Number(userTotalVotes);
          claimsLeftToday = MAX_CLAIMS_PER_DAY;
        }

        return {
          dayIndex: Number(dayIndex),
          votesTodayUsed: Number(votesToday),
          votesLeftToday: Number(votesLeftToday),
          userTotalVotes: Number(userTotalVotes),
          totalVotesGlobal: Number(totalVotesGlobal),
          maxVotesPerDay: Number(maxVotesPerDayOnChain),
          claimableVotes,
          claimsLeftToday
        };
      }

      async function handleVoteClick() {
        try {
          await ensureProvider();
          if (!currentWallet) {
            currentWallet = await connectWallet();
          }

          const fee = await voteContract.voteFeeWei();
          const tx = await voteContract.vote({ value: fee });
          await tx.wait();

          const stats = await loadVoteAndClaimStats(currentWallet);
          showVotingStationWrapper(stats);
        } catch (err) {
          console.error(err);
          alert("Vote failed: " + (err?.shortMessage || err?.message || "Unknown error"));
        }
      }

      async function handleClaimClick() {
        try {
          await ensureProvider();
          if (!currentWallet) {
            currentWallet = await connectWallet();
          }

          const tx = await claimContract.claimOnce();
          await tx.wait();

          const stats = await loadVoteAndClaimStats(currentWallet);
          showVotingStationWrapper(stats);
        } catch (err) {
          console.error(err);
          alert("Claim failed: " + (err?.shortMessage || err?.message || "Unknown error"));
        }
      }

      connectWalletButton.addEventListener("click", async () => {
        try {
          const walletAddress = await connectWallet();
          const poh = isPohVerified(walletAddress);

          if (!poh) {
            showNotVerified();
            return;
          }

          const stats = await loadVoteAndClaimStats(walletAddress);
          showVotingStationWrapper(stats);
        } catch (err) {
          console.error(err);
          alert(
            "Failed to connect wallet: " +
              (err?.shortMessage || err?.message || "Unknown error")
          );
        }
      });

      verifyHereButton.addEventListener("click", () => {
        window.open(
          "https://linea.build/hub/apps/sumsub-reusable-identity",
          "_blank",
          "noopener"
        );
      });

      renderLeaderboard(mockLeaders);
      showConnectOnly();
    </script>
  </body>
</html>
